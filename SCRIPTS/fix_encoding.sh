#!/bin/bash

# ะัะฟัะฐะฒะปะตะฝะธะต ะบะพะดะธัะพะฒะบะธ ะฒ ัััะตััะฒัััะตะน ะฑะฐะทะต ะดะฐะฝะฝัั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./fix_existing_encoding.sh [ะฟััั_ะบ_ะฑะฐะทะต_ะดะฐะฝะฝัั]

set -e

DB_PATH="${1:-./library.db}"

if [[ ! -f "$DB_PATH" ]]; then
    echo "ะัะธะฑะบะฐ: ะะฐะทะฐ ะดะฐะฝะฝัั '$DB_PATH' ะฝะต ะฝะฐะนะดะตะฝะฐ!"
    exit 1
fi

echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะบะพะดะธัะพะฒะบะธ ะฒ ัััะตััะฒัััะตะน ะฑะฐะทะต: $DB_PATH"
echo "================================================"

# ะกะพะทะดะฐะตะผ ัะตะทะตัะฒะฝัั ะบะพะฟะธั
BACKUP_FILE="${DB_PATH}.backup.$(date +%Y%m%d_%H%M%S)"
cp "$DB_PATH" "$BACKUP_FILE"
echo "๐ฆ ะกะพะทะดะฐะฝะฐ ัะตะทะตัะฒะฝะฐั ะบะพะฟะธั: $BACKUP_FILE"

# ะคัะฝะบัะธั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะบะพะฝะบัะตัะฝะพะน ัะตัะธะธ
fix_series() {
    local wrong_encoding="$1"
    local correct_encoding="$2"
    
    echo "๐ ะัะฟัะฐะฒะปะตะฝะธะต: '$wrong_encoding' -> '$correct_encoding'"
    
    sqlite3 "$DB_PATH" "UPDATE books SET series = '$correct_encoding' WHERE series = '$wrong_encoding';"
}

# ะัะฟัะฐะฒะปัะตะผ ะธะทะฒะตััะฝัะต ะฟัะพะฑะปะตะผั
fix_series "ะัะกะะัะกโะยตะกะะกะะัะัะะะยฐะยปะกะะะะกโนะโ ะัะยฑะัะกะะัะกโะยตะะะกะ" "ะัะพัะตััะธะพะฝะฐะปัะฝัะน ะพะฑะพัะพัะตะฝั"
fix_series "ะัะกโฆะัะกโะะะัะัะั ะะะยฐ ะัะยฑะัะกะะัะกโะะะยตะโ" "ะัะพัะฝะธะบะธ ะฝะฐ ะพะฑะพัะพัะฝะตะน"
fix_series "ะโะยฐะัะาะยฐะาะกะะัะัะโ ะะะัะกะ" "ะะฐะณะดะฐะดัะบะธะน ะฒะพั"
fix_series "ะัะยฑะัะกะะัะกโะะะกโนะโ ะัะัะกะะัะา" "ะะฑะพัะพัะฝัะน ะณะพัะพะด"
fix_series "ะัะยฐะกะะัะกโฆ" "ะะฐัะณั"

# ะะพะบะฐะทัะฒะฐะตะผ ัะตะทัะปััะฐัั
echo ""
echo "โ ะะตะทัะปััะฐัั ะธัะฟัะฐะฒะปะตะฝะธั:"
sqlite3 -header -column "$DB_PATH" "SELECT series, COUNT(*) as count FROM books WHERE series IS NOT NULL GROUP BY series ORDER BY count DESC LIMIT 10;"

echo ""
echo "๐ ะัะฟัะฐะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐พ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั ัะพััะฐะฝะตะฝะฐ ะฒ: $BACKUP_FILE"