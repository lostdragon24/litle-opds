./config/config.php
<?php

class Config {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const DB_TYPE =  'mysql'; // –∏–ª–∏ 'mysql', 'pgsql'
    const DB_PATH = '/path/to/db/library.db';
    const DB_HOST = 'localhost';
    const DB_USER = 'opds';
    const DB_PASS = 'password
    const DB_NAME = 'mybook';
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞
    const BOOKS_DIR = '/mnt/sda1/book/_Lib.rus.ec - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è/lib.rus.ec/';
    const SCANNER_PATH = __DIR__ . '/home/pi/opds2/';
    const SCANNER_CONFIG = __DIR__ . '/config.ini';
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const SITE_TITLE = '–ú–æ—è –¥–æ–º–∞—à–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞';
    const ITEMS_PER_PAGE = 20;
//    const CACHE_DIR = __DIR__ . '/home/pi/opds2/cache';
//    const COVER_CACHE_DIR = __DIR__ . '/home/pi/opds2/covers';
    const CACHE_DIR = '/var/www/html/4/cache';  // –ò–∑–º–µ–Ω—è–µ–º –ø—É—Ç—å
    const COVER_CACHE_DIR = '/var/www/html/4/cache/covers';  // –ò–∑–º–µ–Ω—è–µ–º –ø—É—Ç—å
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OPDS
    const OPDS_TITLE = '–ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞';
    const OPDS_AUTHOR = 'Book Scanner';
    const OPDS_ID = 'urn:uuid:your-uuid-here';
    
    public static function init() {
        // –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if (!file_exists(self::CACHE_DIR)) {
            mkdir(self::CACHE_DIR, 0755, true);
        }
        if (!file_exists(self::COVER_CACHE_DIR)) {
            mkdir(self::COVER_CACHE_DIR, 0755, true);
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!file_exists(self::SCANNER_CONFIG)) {
            self::createScannerConfig();
        }
    }
    
    private static function createScannerConfig() {
        $config_content = "[database]\n";
        $config_content .= "type = " . self::DB_TYPE . "\n";
        
        if (self::DB_TYPE === 'sqlite') {
            $config_content .= "path = " . self::DB_PATH . "\n";
        } else {
            $config_content .= "host = " . self::DB_HOST . "\n";
            $config_content .= "user = " . self::DB_USER . "\n";
            $config_content .= "password = " . self::DB_PASS . "\n";
            $config_content .= "database = " . self::DB_NAME . "\n";
        }
        
        $config_content .= "\n[scanner]\n";
        $config_content .= "books_dir = " . self::BOOKS_DIR . "\n";
        $config_content .= "log_file = NULL\n";
        
        file_put_contents(self::SCANNER_CONFIG, $config_content);
    }


const FB2_GENRES = [
        // –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞
        'sf_history' => '–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è',
        'sf_action' => '–ë–æ–µ–≤–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_epic' => '–≠–ø–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_heroic' => '–ì–µ—Ä–æ–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_detective' => '–î–µ—Ç–µ–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_cyberpunk' => '–ö–∏–±–µ—Ä–ø–∞–Ω–∫',
        'sf_space' => '–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_social' => '–°–æ—Ü–∏–∞–ª—å–Ω–æ-–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_horror' => '–£–∂–∞—Å—ã –∏ –ú–∏—Å—Ç–∏–∫–∞',
        'sf_humor' => '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'sf_fantasy' => '–§—ç–Ω—Ç–µ–∑–∏',
        'sf' => '–ù–∞—É—á–Ω–∞—è –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        
        // –î–µ—Ç–µ–∫—Ç–∏–≤—ã –∏ –¢—Ä–∏–ª–ª–µ—Ä—ã
        'det_classic' => '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_police' => '–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_action' => '–ë–æ–µ–≤–∏–∫',
        'det_irony' => '–ò—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_history' => '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_espionage' => '–®–ø–∏–æ–Ω—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_crime' => '–ö—Ä–∏–º–∏–Ω–∞–ª—å–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_political' => '–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'det_maniac' => '–ú–∞–Ω—å—è–∫–∏',
        'det_hard' => '–ö—Ä—É—Ç–æ–π –¥–µ—Ç–µ–∫—Ç–∏–≤',
        'thriller' => '–¢—Ä–∏–ª–ª–µ—Ä',
        'detective' => '–î–µ—Ç–µ–∫—Ç–∏–≤',
        
        // –ü—Ä–æ–∑–∞
        'prose_classic' => '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        'prose_history' => '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        'prose_contemporary' => '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–∑–∞',
        'prose_counter' => '–ö–æ–Ω—Ç—Ä–∫—É–ª—å—Ç—É—Ä–∞',
        'prose_rus_classic' => '–†—É—Å—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        'prose_su_classics' => '–°–æ–≤–µ—Ç—Å–∫–∞—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        
        // –õ—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã
        'love_contemporary' => '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã',
        'love_history' => '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã',
        'love_detective' => '–û—Å—Ç—Ä–æ—Å—é–∂–µ—Ç–Ω—ã–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã',
        'love_short' => '–ö–æ—Ä–æ—Ç–∫–∏–µ –ª—é–±–æ–≤–Ω—ã–µ —Ä–æ–º–∞–Ω—ã',
        'love_erotica' => '–≠—Ä–æ—Ç–∏–∫–∞',
        
        // –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è
        'adv_western' => '–í–µ—Å—Ç–µ—Ä–Ω',
        'adv_history' => '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
        'adv_indian' => '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ –∏–Ω–¥–µ–π—Ü–µ–≤',
        'adv_maritime' => '–ú–æ—Ä—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
        'adv_geo' => '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è',
        'adv_animal' => '–ü—Ä–∏—Ä–æ–¥–∞ –∏ –∂–∏–≤–æ—Ç–Ω—ã–µ',
        'adventure' => '–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
        
        // –î–µ—Ç—Å–∫–æ–µ
        'child_tale' => '–°–∫–∞–∑–∫–∞',
        'child_verse' => '–î–µ—Ç—Å–∫–∏–µ —Å—Ç–∏—Ö–∏',
        'child_prose' => '–î–µ—Ç—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        'child_sf' => '–î–µ—Ç—Å–∫–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞',
        'child_det' => '–î–µ—Ç—Å–∫–∏–µ –æ—Å—Ç—Ä–æ—Å—é–∂–µ—Ç–Ω—ã–µ',
        'child_adv' => '–î–µ—Ç—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è',
        'child_education' => '–î–µ—Ç—Å–∫–∞—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'children' => '–î–µ—Ç—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –ü–æ—ç–∑–∏—è, –î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è
        'poetry' => '–ü–æ—ç–∑–∏—è',
        'dramaturgy' => '–î—Ä–∞–º–∞—Ç—É—Ä–≥–∏—è',
        
        // –°—Ç–∞—Ä–∏–Ω–Ω–æ–µ
        'antique_ant' => '–ê–Ω—Ç–∏—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'antique_european' => '–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è —Å—Ç–∞—Ä–∏–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'antique_russian' => '–î—Ä–µ–≤–Ω–µ—Ä—É—Å—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'antique_east' => '–î—Ä–µ–≤–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'antique_myths' => '–ú–∏—Ñ—ã. –õ–µ–≥–µ–Ω–¥—ã. –≠–ø–æ—Å',
        'antique' => '–°—Ç–∞—Ä–∏–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –ù–∞—É–∫–∞, –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
        'sci_history' => '–ò—Å—Ç–æ—Ä–∏—è',
        'sci_psychology' => '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è',
        'sci_culture' => '–ö—É–ª—å—Ç—É—Ä–æ–ª–æ–≥–∏—è',
        'sci_religion' => '–†–µ–ª–∏–≥–∏–æ–≤–µ–¥–µ–Ω–∏–µ',
        'sci_philosophy' => '–§–∏–ª–æ—Å–æ—Ñ–∏—è',
        'sci_politics' => '–ü–æ–ª–∏—Ç–∏–∫–∞',
        'sci_business' => '–î–µ–ª–æ–≤–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        'sci_juris' => '–Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è',
        'sci_linguistic' => '–Ø–∑—ã–∫–æ–∑–Ω–∞–Ω–∏–µ',
        'sci_medicine' => '–ú–µ–¥–∏—Ü–∏–Ω–∞',
        'sci_phys' => '–§–∏–∑–∏–∫–∞',
        'sci_math' => '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
        'sci_chem' => '–•–∏–º–∏—è',
        'sci_biology' => '–ë–∏–æ–ª–æ–≥–∏—è',
        'sci_tech' => '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞—É–∫–∏',
        'science' => '–ù–∞—É—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –ö–æ–º–ø—å—é—Ç–µ—Ä—ã –∏ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
        'comp_www' => '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç',
        'comp_programming' => '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
        'comp_hard' => '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∂–µ–ª–µ–∑–æ',
        'comp_soft' => '–ü—Ä–æ–≥—Ä–∞–º–º—ã',
        'comp_db' => '–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö',
        'comp_osnet' => '–û–° –∏ –°–µ—Ç–∏',
        'computers' => '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞
        'ref_encyc' => '–≠–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏',
        'ref_dict' => '–°–ª–æ–≤–∞—Ä–∏',
        'ref_ref' => '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏',
        'ref_guide' => '–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞',
        'reference' => '–°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞
        'nonf_biography' => '–ë–∏–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ú–µ–º—É–∞—Ä—ã',
        'nonf_publicism' => '–ü—É–±–ª–∏—Ü–∏—Å—Ç–∏–∫–∞',
        'nonf_criticism' => '–ö—Ä–∏—Ç–∏–∫–∞',
        'design' => '–ò—Å–∫—É—Å—Å—Ç–≤–æ –∏ –î–∏–∑–∞–π–Ω',
        'nonfiction' => '–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –†–µ–ª–∏–≥–∏—è –∏ –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å
        'religion_rel' => '–†–µ–ª–∏–≥–∏—è',
        'religion_esoterics' => '–≠–∑–æ—Ç–µ—Ä–∏–∫–∞',
        'religion_self' => '–°–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–µ',
        'religion' => '–†–µ–ª–∏–≥–∏–æ–∑–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
        
        // –Æ–º–æ—Ä
        'humor_anecdote' => '–ê–Ω–µ–∫–¥–æ—Ç—ã',
        'humor_prose' => '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∑–∞',
        'humor_verse' => '–Æ–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏—Ö–∏',
        'humor' => '–Æ–º–æ—Ä',
        
        // –î–æ–º–æ–≤–æ–¥—Å—Ç–≤–æ
        'home_cooking' => '–ö—É–ª–∏–Ω–∞—Ä–∏—è',
        'home_pets' => '–î–æ–º–∞—à–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã–µ',
        'home_crafts' => '–•–æ–±–±–∏ –∏ —Ä–µ–º–µ—Å–ª–∞',
        'home_entertain' => '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è',
        'home_health' => '–ó–¥–æ—Ä–æ–≤—å–µ',
        'home_garden' => '–°–∞–¥ –∏ –æ–≥–æ—Ä–æ–¥',
        'home_diy' => '–°–¥–µ–ª–∞–π —Å–∞–º',
        'home_sport' => '–°–ø–æ—Ä—Ç',
        'home_sex' => '–≠—Ä–æ—Ç–∏–∫–∞, –°–µ–∫—Å',
        'home' => '–î–æ–º–æ–≤–æ–¥—Å—Ç–≤–æ'
    ];

}

Config::init();
?>
./create_favicon.php
<?php
// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π favicon
$image = imagecreate(16, 16);
$bgColor = imagecolorallocate($image, 70, 130, 180);
$textColor = imagecolorallocate($image, 255, 255, 255);

imagestring($image, 1, 4, 2, 'ASP', $textColor);

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ ICO (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ PNG, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
imagepng($image, __DIR__ . '/favicon.ico');
imagedestroy($image);

echo "Favicon created at: " . __DIR__ . "/favicon.ico\n";
?>
./debug_covers.php
<?php
require_once 'config/config.php';
require_once 'lib/Database.php';
require_once 'lib/Fb2CoverParser.php';

error_reporting(E_ALL);
ini_set('display_errors', 1);

$db = Database::getInstance();
$books = $db->getRecentBooks(10);

echo "<!DOCTYPE html>
<html>
<head>
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–±–ª–æ–∂–µ–∫</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .book-info { border: 1px solid #ccc; margin: 10px; padding: 15px; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .debug-info { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        img { max-width: 200px; border: 2px solid #ccc; margin: 5px; }
        details { margin: 10px 0; }
        summary { cursor: pointer; font-weight: bold; }
        pre { background: #f0f0f0; padding: 10px; overflow: auto; }
        .stats { background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>";

echo "<h1>üîç –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–±–ª–æ–∂–µ–∫</h1>";

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
$totalBooks = count($books);
$booksWithCovers = 0;
$booksWithCoversInFile = 0;

foreach ($books as $book) {
    $coverPath = Config::COVER_CACHE_DIR . '/' . $book['id'] . '.jpg';
    $thumbPath = Config::COVER_CACHE_DIR . '/' . $book['id'] . '_thumb.jpg';
    
    if (file_exists($coverPath) || file_exists($thumbPath)) {
        $booksWithCovers++;
    }
}

echo "<div class='stats'>
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <p>–í—Å–µ–≥–æ –∫–Ω–∏–≥: <strong>{$totalBooks}</strong></p>
    <p>–° –æ–±–ª–æ–∂–∫–∞–º–∏ –≤ –∫—ç—à–µ: <strong>{$booksWithCovers}</strong></p>
    <p>–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫—ç—à–∞: <code>" . Config::COVER_CACHE_DIR . "</code> - " . 
    (is_writable(Config::COVER_CACHE_DIR) ? "‚úÖ WRITABLE" : "‚ùå NOT WRITABLE") . "</p>
</div>";

foreach ($books as $book) {
    echo "<div class='book-info'>";
    echo "<h3>üìö ID: {$book['id']} - " . htmlspecialchars($book['title'] ?: '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è') . "</h3>";
    echo "<p><strong>–ê–≤—Ç–æ—Ä:</strong> " . htmlspecialchars($book['author'] ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω') . "</p>";
    echo "<p><strong>–§–æ—Ä–º–∞—Ç:</strong> " . strtoupper($book['file_type']) . "</p>";
    
    if ($book['archive_path']) {
        echo "<p><strong>–ê—Ä—Ö–∏–≤:</strong> " . htmlspecialchars(basename($book['archive_path'])) . "</p>";
        echo "<p><strong>–§–∞–π–ª –≤ –∞—Ä—Ö–∏–≤–µ:</strong> " . htmlspecialchars($book['archive_internal_path']) . "</p>";
    } else {
        echo "<p><strong>–§–∞–π–ª:</strong> " . htmlspecialchars($book['file_path']) . "</p>";
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    $fileExists = file_exists($book['file_path']);
    $archiveExists = $book['archive_path'] ? file_exists($book['archive_path']) : true;
    
    echo "<p><strong>–§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:</strong> " . 
         ($fileExists ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "</p>";
    echo "<p><strong>–ê—Ä—Ö–∏–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:</strong> " . 
         ($archiveExists ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "</p>";
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –æ–±–ª–æ–∂–µ–∫
    $coverPath = Config::COVER_CACHE_DIR . '/' . $book['id'] . '.jpg';
    $thumbPath = Config::COVER_CACHE_DIR . '/' . $book['id'] . '_thumb.jpg';
    
    echo "<p><strong>–û–±–ª–æ–∂–∫–∞ –≤ –∫—ç—à–µ:</strong> " . 
         (file_exists($coverPath) ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "</p>";
    echo "<p><strong>–ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –≤ –∫—ç—à–µ:</strong> " . 
         (file_exists($thumbPath) ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "</p>";
    
    // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –æ–±–ª–æ–∂–∫—É
    echo "<h4>üñºÔ∏è –¢–µ—Å—Ç –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏:</h4>";
    
    $content = getBookContent($book);
    if ($content === false) {
        echo "<p class='error'>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏</p>";
    } else {
        echo "<p><strong>–†–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:</strong> " . number_format(strlen($content)) . " –±–∞–π—Ç</p>";
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
        $imageData = Fb2CoverParser::findCover($content);
        
        if ($imageData) {
            $booksWithCoversInFile++;
            $imageInfo = Fb2CoverParser::getImageInfo($imageData);
            echo "<p class='success'>‚úÖ –û–±–ª–æ–∂–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ!</p>";
            echo "<p><strong>–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</strong> " . number_format(strlen($imageData)) . " –±–∞–π—Ç</p>";
            
            if ($imageInfo) {
                echo "<p><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:</strong> " . 
                     "{$imageInfo['mime']}, {$imageInfo['width']}√ó{$imageInfo['height']} –ø–∏–∫—Å–µ–ª–µ–π</p>";
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (saveTestCover($imageData, $book['id'])) {
                echo "<p class='success'>‚úÖ –û–±–ª–æ–∂–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∫—ç—à</p>";
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–æ–∂–∫–∏
                echo "<div>";
                echo "<img src='./api/cover_simple.php?id={$book['id']}' title='–ü–æ–ª–Ω–∞—è –æ–±–ª–æ–∂–∫–∞' style='border-color: green;'>";
                echo "<img src='./api/cover_simple.php?id={$book['id']}&thumb=1' title='–ú–∏–Ω–∏–∞—Ç—é—Ä–∞' style='border-color: blue;'>";
                echo "</div>";
                
                echo "<p><strong>–°—Å—ã–ª–∫–∏:</strong> ";
                echo "<a href='./api/cover_simple.php?id={$book['id']}' target='_blank'>–ü–æ–ª–Ω–∞—è</a> | ";
                echo "<a href='./api/cover_simple.php?id={$book['id']}&thumb=1' target='_blank'>–ú–∏–Ω–∏–∞—Ç—é—Ä–∞</a>";
                echo "</p>";
            } else {
                echo "<p class='error'>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É –≤ –∫—ç—à</p>";
            }
        } else {
            echo "<p class='warning'>‚ö†Ô∏è –û–±–ª–æ–∂–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ</p>";
            
            // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            echo "<details>";
            echo "<summary>üîç –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ FB2 —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</summary>";
            echo "<div class='debug-info'>";
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É FB2
            analyzeFb2Structure($content);
            
            echo "</div>";
            echo "</details>";
        }
    }
    
    echo "</div>";
}

// –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo "<div class='stats'>
    <h3>üìà –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <p>–í—Å–µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–Ω–∏–≥: <strong>{$totalBooks}</strong></p>
    <p>–° –æ–±–ª–æ–∂–∫–∞–º–∏ –≤ –∫—ç—à–µ: <strong>{$booksWithCovers}</strong></p>
    <p>–° –æ–±–ª–æ–∂–∫–∞–º–∏ –≤ —Ñ–∞–π–ª–∞—Ö: <strong>{$booksWithCoversInFile}</strong></p>
    <p>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞: <strong>" . 
        ($totalBooks > 0 ? round(($booksWithCoversInFile / $totalBooks) * 100, 1) : 0) . "%</strong></p>
</div>";

echo "</body></html>";

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏
 */
function getBookContent($book) {
    if ($book['archive_path'] && $book['archive_internal_path']) {
        $zip = new ZipArchive();
        if ($zip->open($book['archive_path']) === TRUE) {
            $content = $zip->getFromName($book['archive_internal_path']);
            $zip->close();
            return $content;
        }
        return false;
    } else {
        return file_get_contents($book['file_path']);
    }
}

/**
 * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –æ–±–ª–æ–∂–∫—É
 */
function saveTestCover($imageData, $bookId) {
    $coverPath = Config::COVER_CACHE_DIR . '/' . $bookId . '.jpg';
    $thumbPath = Config::COVER_CACHE_DIR . '/' . $bookId . '_thumb.jpg';
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!file_exists(Config::COVER_CACHE_DIR)) {
        mkdir(Config::COVER_CACHE_DIR, 0755, true);
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω—É—é –æ–±–ª–æ–∂–∫—É
    if (file_put_contents($coverPath, $imageData) === false) {
        return false;
    }
    
    // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É
    return createThumbnailFromData($imageData, $thumbPath, 200, 300);
}

/**
 * –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö
 */
function createThumbnailFromData($imageData, $destPath, $maxWidth, $maxHeight) {
    $tempFile = tempnam(sys_get_temp_dir(), 'cover_');
    file_put_contents($tempFile, $imageData);
    
    $imageInfo = getimagesize($tempFile);
    if (!$imageInfo) {
        unlink($tempFile);
        return false;
    }
    
    list($width, $height, $type) = $imageInfo;
    
    switch ($type) {
        case IMAGETYPE_JPEG:
            $source = imagecreatefromjpeg($tempFile);
            break;
        case IMAGETYPE_PNG:
            $source = imagecreatefrompng($tempFile);
            break;
        case IMAGETYPE_GIF:
            $source = imagecreatefromgif($tempFile);
            break;
        default:
            unlink($tempFile);
            return false;
    }
    
    if (!$source) {
        unlink($tempFile);
        return false;
    }
    
    $ratio = min($maxWidth / $width, $maxHeight / $height);
    $newWidth = (int)($width * $ratio);
    $newHeight = (int)($height * $ratio);
    
    $thumb = imagecreatetruecolor($newWidth, $newHeight);
    
    if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
        imagecolortransparent($thumb, imagecolorallocatealpha($thumb, 0, 0, 0, 127));
        imagealphablending($thumb, false);
        imagesavealpha($thumb, true);
    }
    
    imagecopyresampled($thumb, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);
    
    $result = imagejpeg($thumb, $destPath, 85);
    
    imagedestroy($source);
    imagedestroy($thumb);
    unlink($tempFile);
    
    return $result;
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É FB2 —Ñ–∞–π–ª–∞
 */
function analyzeFb2Structure($content) {
    echo "<h5>–ü–æ–∏—Å–∫ coverpage:</h5>";
    
    $methods = [
        'l:href' => '/<coverpage>.*?<image[^>]*l:href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is',
        'xlink:href' => '/<coverpage>.*?<image[^>]*xlink:href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is',
        'href' => '/<coverpage>.*?<image[^>]*href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is',
        '–ø—Ä–æ—Å—Ç–æ–π coverpage' => '/<coverpage>.*?<\/coverpage>/is'
    ];
    
    foreach ($methods as $method => $pattern) {
        if (preg_match($pattern, $content, $matches)) {
            echo "<p>‚úÖ –ù–∞–π–¥–µ–Ω coverpage (<strong>{$method}</strong>)";
            if (isset($matches[1])) {
                echo " - ID: <code>{$matches[1]}</code></p>";
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π binary
                $binaryPattern = '/<binary[^>]*id[[:space:]]*=[[:space:]]*["\']' . preg_quote($matches[1], '/') . '["\'][^>]*>/i';
                if (preg_match($binaryPattern, $content)) {
                    echo "<p>‚úÖ –ù–∞–π–¥–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π binary —Ç–µ–≥</p>";
                } else {
                    echo "<p>‚ùå Binary —Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>";
                }
            } else {
                echo " (–±–µ–∑ ID)</p>";
            }
        } else {
            echo "<p>‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω coverpage (<strong>{$method}</strong>)</p>";
        }
    }
    
    echo "<h5>Binary —Ç–µ–≥–∏:</h5>";
    if (preg_match_all('/<binary[^>]*id[[:space:]]*=[[:space:]]*["\']([^"\']+)["\'][^>]*>/i', $content, $binaries)) {
        echo "<p>‚úÖ –ù–∞–π–¥–µ–Ω—ã binary —Ç–µ–≥–∏: " . count($binaries[1]) . "</p>";
        echo "<ul>";
        foreach ($binaries[1] as $binaryId) {
            echo "<li><code>{$binaryId}</code></li>";
        }
        echo "</ul>";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã binary –¥–∞–Ω–Ω—ã—Ö
        if (preg_match_all('/<binary[^>]*>([^<]*)<\/binary>/is', $content, $allBinaries)) {
            echo "<h5>–†–∞–∑–º–µ—Ä—ã binary –¥–∞–Ω–Ω—ã—Ö:</h5>";
            foreach ($allBinaries[1] as $index => $binaryData) {
                $decoded = base64_decode(trim($binaryData));
                $size = strlen($decoded);
                echo "<p>Binary #" . ($index + 1) . ": " . number_format($size) . " –±–∞–π—Ç - ";
                
                if (Fb2CoverParser::isValidImage($decoded)) {
                    echo "‚úÖ –í–∞–ª–∏–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>";
                } else {
                    echo "‚ùå –ù–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>";
                }
            }
        }
    } else {
        echo "<p>‚ùå Binary —Ç–µ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>";
    }
    
    echo "<h5>–î—Ä—É–≥–∏–µ —Ç–µ–≥–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏:</h5>";
    $imageTags = [
        'image' => 'image',
        'img' => 'img',
        'cover' => 'cover'
    ];
    
    foreach ($imageTags as $tag => $name) {
        $pattern = '/<' . $tag . '[^>]*>/i';
        if (preg_match_all($pattern, $content, $matches)) {
            echo "<p>‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ç–µ–≥–∏ &lt;{$tag}&gt;: " . count($matches[0]) . "</p>";
            foreach ($matches[0] as $tagContent) {
                echo "<pre>" . htmlspecialchars($tagContent) . "</pre>";
            }
        }
    }
}
?>
./check_permissions.php
<?php
require_once 'config/config.php';

echo "<h1>üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞</h1>";

$paths = [
    Config::COVER_CACHE_DIR,
    '/var/www/html/4/cache',
    '/var/www/html/4/cache/covers',
    '/var/www/html/4/api'
];

foreach ($paths as $path) {
    echo "<h3>üìÅ {$path}</h3>";
    
    if (file_exists($path)) {
        $perms = fileperms($path);
        echo "–°—É—â–µ—Å—Ç–≤—É–µ—Ç: ‚úÖ –î–ê<br>";
        echo "–ü—Ä–∞–≤–∞: " . substr(sprintf('%o', $perms), -3) . "<br>";
        echo "–ß—Ç–µ–Ω–∏–µ: " . (is_readable($path) ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "<br>";
        echo "–ó–∞–ø–∏—Å—å: " . (is_writable($path) ? "‚úÖ –î–ê" : "‚ùå –ù–ï–¢") . "<br>";
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
        $owner = fileowner($path);
        $group = filegroup($path);
        echo "–í–ª–∞–¥–µ–ª–µ—Ü: " . posix_getpwuid($owner)['name'] . "<br>";
        echo "–ì—Ä—É–ø–ø–∞: " . posix_getgrgid($group)['name'] . "<br>";
        
        // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
        $files = glob($path . '/*.jpg');
        echo "–§–∞–π–ª–æ–≤ .jpg: " . count($files) . "<br>";
        if (count($files) > 0) {
            $testFile = $files[0];
            echo "–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª: " . basename($testFile) . " - ";
            echo is_readable($testFile) ? "‚úÖ –ß–∏—Ç–∞–µ—Ç—Å—è" : "‚ùå –ù–µ —á–∏—Ç–∞–µ—Ç—Å—è";
        }
    } else {
        echo "–°—É—â–µ—Å—Ç–≤—É–µ—Ç: ‚ùå –ù–ï–¢<br>";
    }
    echo "<hr>";
}
?>
./templates/footer.php
    </div>
    
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h6><?php echo htmlspecialchars(Config::SITE_TITLE); ?></h6>
                    <p class="mb-0">–í–∞—à–∞ –ª–∏—á–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π OPDS</p>
                </div>
                <div class="col-md-4 text-end">
                    <?php
                    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞
                    try {
                        $db = Database::getInstance();
                        $stats = $db->getCollectionStats();
                    } catch (Exception $e) {
                        $stats = [
                            'total_books' => 0,
                            'total_authors' => 0,
                            'total_genres' => 0,
                            'total_series' => 0,
                            'last_update' => null
                        ];
                    }
                    ?>
                    
                    <div class="stats">
                        <small>
                            <strong>–ö–æ–ª–ª–µ–∫—Ü–∏—è:</strong><br>
                            –ö–Ω–∏–≥: <?php echo number_format($stats['total_books'], 0, '', ' '); ?> | 
                            –ê–≤—Ç–æ—Ä–æ–≤: <?php echo number_format($stats['total_authors'], 0, '', ' '); ?> | 
                            –ñ–∞–Ω—Ä–æ–≤: <?php echo number_format($stats['total_genres'], 0, '', ' '); ?>
                            <?php if ($stats['total_series'] > 0): ?>
                                | –°–µ—Ä–∏–π: <?php echo number_format($stats['total_series'], 0, '', ' '); ?>
                            <?php endif; ?>
                        </small>
                        <?php if ($stats['last_update']): ?>
                            <br>
                            <small>
                                <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> 
                                <?php echo date('d.m.Y', strtotime($stats['last_update'])); ?>
                            </small>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <hr class="my-2">
            <div class="row">
                <div class="col-12 text-center">
                    <small>
                        &copy; <?php echo date('Y'); ?> <?php echo htmlspecialchars(Config::SITE_TITLE); ?> | 
                        <a href="./api/opds.php" class="text-light">OPDS-–∫–∞—Ç–∞–ª–æ–≥</a> | 
                        –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤: EPUB, FB2, PDF, MOBI, TXT
                    </small>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
./templates/header.php
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo htmlspecialchars(Config::SITE_TITLE); ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .book-cover { max-width: 100px; height: auto; }
        .book-card { margin-bottom: 20px; }
        .search-form { margin-bottom: 30px; }
        .stats { font-size: 0.85rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.php"><?php echo htmlspecialchars(Config::SITE_TITLE); ?></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.php">–ì–ª–∞–≤–Ω–∞—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="stats.php">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./api/opds.php" target="_blank">OPDS</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
./book_detail.php
<?php

require_once 'config/config.php';
require_once 'lib/Database.php';
require_once 'lib/Fb2CoverParser.php';

$db = Database::getInstance();

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    die('–ù–µ–≤–µ—Ä–Ω—ã–π ID –∫–Ω–∏–≥–∏');
}

$bookId = intval($_GET['id']);
$book = $db->getBook($bookId);

if (!$book) {
    die('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
}

// –ü–æ–ª—É—á–∞–µ–º —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞
$readableGenre = $db->getReadableGenre($book['genre']);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–ª–æ–∂–∫–∏ –≤ –∫–Ω–∏–≥–µ
$hasCover = hasBookCover($book);

require 'templates/header.php';
?>

<div class="row">
    <div class="col-md-3 text-center">
        <?php if ($hasCover): ?>
            <img src="./api/cover_direct.php?id=<?php echo $book['id']; ?>" 
                 class="img-fluid mb-3" 
                 alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏ <?php echo htmlspecialchars($book['title']); ?>"
                 style="max-width: 100%; height: auto;"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            
            <!-- –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
            <div class="mt-2">
                <small class="text-muted">–ú–∏–Ω–∏–∞—Ç—é—Ä–∞:</small><br>
                <img src="./api/cover_direct.php?id=<?php echo $book['id']; ?>&thumb=1" 
                     class="img-thumbnail" 
                     alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞"
                     style="max-width: 100px;">
            </div>
        <?php else: ?>
            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 400px;">
                <span class="text-muted">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</span>
            </div>
        <?php endif; ?>
        
        <div class="mt-3">
            <a href="./api/download.php?id=<?php echo $book['id']; ?>" class="btn btn-success btn-lg w-100 mb-2">
                üì• –°–∫–∞—á–∞—Ç—å –∫–Ω–∏–≥—É
            </a>
            <a href="./api/opds.php" class="btn btn-outline-secondary btn-sm w-100">OPDS-–∫–∞—Ç–∞–ª–æ–≥</a>
        </div>
        
        <!-- –ë–ª–æ–∫ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
        <div class="card mt-3">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ</h6>
            </div>
            <div class="card-body p-2">
                <small>
                    <strong>–§–æ—Ä–º–∞—Ç:</strong> <?php echo strtoupper($book['file_type']); ?><br>
                    <?php if ($book['archive_path']): ?>
                        <strong>–í –∞—Ä—Ö–∏–≤–µ:</strong> <?php echo htmlspecialchars(basename($book['archive_path'])); ?><br>
                        <strong>–§–∞–π–ª:</strong> <?php echo htmlspecialchars($book['archive_internal_path']); ?>
                    <?php else: ?>
                        <strong>–§–∞–π–ª:</strong> <?php echo htmlspecialchars(basename($book['file_path'])); ?>
                    <?php endif; ?>
                    <?php if ($hasCover): ?>
                        <br><strong>–û–±–ª–æ–∂–∫–∞:</strong> ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è
                    <?php else: ?>
                        <br><strong>–û–±–ª–æ–∂–∫–∞:</strong> ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                    <?php endif; ?>
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.php">üè† –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item active"><?php echo htmlspecialchars($book['title'] ?: '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'); ?></li>
            </ol>
        </nav>
        
        <h1 class="display-6"><?php echo htmlspecialchars($book['title'] ?: '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'); ?></h1>
        
        <?php if ($book['author']): ?>
            <p class="lead">
                <strong>‚úçÔ∏è –ê–≤—Ç–æ—Ä:</strong> 
                <a href="index.php?field=author&q=<?php echo urlencode($book['author']); ?>" class="text-decoration-none fw-bold">
                    <?php echo htmlspecialchars($book['author']); ?>
                </a>
            </p>
        <?php endif; ?>
        
        <!-- –ë–ª–æ–∫ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ -->
        <div class="row mb-4">
            <?php if ($readableGenre): ?>
                <div class="col-md-6 mb-2">
                    <div class="card h-100">
                        <div class="card-body py-2">
                            <strong>üìö –ñ–∞–Ω—Ä:</strong><br>
                            <a href="index.php?field=genre&q=<?php echo urlencode($book['genre']); ?>" class="badge bg-primary text-decoration-none">
                                <?php echo htmlspecialchars($readableGenre); ?>
                            </a>
                            <?php if ($book['genre'] !== $readableGenre): ?>
                                <br><small class="text-muted">(<?php echo htmlspecialchars($book['genre']); ?>)</small>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <?php if ($book['series']): ?>
                <div class="col-md-6 mb-2">
                    <div class="card h-100">
                        <div class="card-body py-2">
                            <strong>üìñ –°–µ—Ä–∏—è:</strong><br>
                            <a href="index.php?field=series&q=<?php echo urlencode($book['series']); ?>" class="text-decoration-none">
                                <?php echo htmlspecialchars($book['series']); ?>
                            </a>
                            <?php if ($book['series_number']): ?>
                                <span class="badge bg-secondary">–ö–Ω–∏–≥–∞ <?php echo $book['series_number']; ?></span>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <?php if ($book['year']): ?>
                <div class="col-md-3 mb-2">
                    <div class="card h-100">
                        <div class="card-body py-2 text-center">
                            <strong>üìÖ –ì–æ–¥</strong><br>
                            <?php echo $book['year']; ?>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <?php if ($book['language']): ?>
                <div class="col-md-3 mb-2">
                    <div class="card h-100">
                        <div class="card-body py-2 text-center">
                            <strong>üåê –Ø–∑—ã–∫</strong><br>
                            <?php 
                            $languages = [
                                'ru' => '–†—É—Å—Å–∫–∏–π',
                                'en' => '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π',
                                'de' => '–ù–µ–º–µ—Ü–∫–∏–π',
                                'fr' => '–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π',
                                'es' => '–ò—Å–ø–∞–Ω—Å–∫–∏–π',
                                'pl' => '–ü–æ–ª—å—Å–∫–∏–π'
                            ];
                            echo $languages[strtolower($book['language'])] ?? strtoupper($book['language']); 
                            ?>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <?php if ($book['publisher']): ?>
                <div class="col-md-6 mb-2">
                    <div class="card h-100">
                        <div class="card-body py-2">
                            <strong>üè¢ –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</strong><br>
                            <?php echo htmlspecialchars($book['publisher']); ?>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
        </div>
        
        <?php if ($book['description']): ?>
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìù –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    <p class="card-text"><?php echo nl2br(htmlspecialchars($book['description'])); ?></p>
                </div>
            </div>
        <?php endif; ?>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>üìÅ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å:</strong><br>
                        <small class="text-muted"><?php echo htmlspecialchars($book['file_path']); ?></small></p>
                        
                        <?php if ($book['archive_path']): ?>
                            <p><strong>üóúÔ∏è –ê—Ä—Ö–∏–≤:</strong><br>
                            <small class="text-muted"><?php echo htmlspecialchars($book['archive_path']); ?></small></p>
                            
                            <p><strong>üìÑ –§–∞–π–ª –≤ –∞—Ä—Ö–∏–≤–µ:</strong><br>
                            <small class="text-muted"><?php echo htmlspecialchars($book['archive_internal_path']); ?></small></p>
                        <?php endif; ?>
                    </div>
                    <div class="col-md-6">
                        <p><strong>‚è∞ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥:</strong><br>
                        <small class="text-muted"><?php echo date('d.m.Y H:i', strtotime($book['added_date'])); ?></small></p>
                        
                        <?php if ($book['last_modified'] && $book['last_modified'] !== $book['added_date']): ?>
                            <p><strong>‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong><br>
                            <small class="text-muted"><?php echo date('d.m.Y H:i', strtotime($book['last_modified'])); ?></small></p>
                        <?php endif; ?>
                        
                        <?php if ($hasCover): ?>
                            <p><strong>üñºÔ∏è –û–±–ª–æ–∂–∫–∞:</strong><br>
                            <small class="text-success">‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏</small></p>
                        <?php else: ?>
                            <p><strong>üñºÔ∏è –û–±–ª–æ–∂–∫–∞:</strong><br>
                            <small class="text-muted">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ñ–∞–π–ª–µ</small></p>
                        <?php endif; ?>
                    </div>
                </div>
                
                <!-- –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±–ª–æ–∂–∫—É -->
                <?php if ($hasCover): ?>
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6>üîó –°—Å—ã–ª–∫–∏ –Ω–∞ –æ–±–ª–æ–∂–∫—É:</h6>
                        <div class="btn-group" role="group">
                            <a href="./api/cover_direct.php?id=<?php echo $book['id']; ?>" 
                               class="btn btn-outline-primary btn-sm" target="_blank">
                                –ü–æ–ª–Ω–∞—è –æ–±–ª–æ–∂–∫–∞
                            </a>
                            <a href="./api/cover_direct.php?id=<?php echo $book['id']; ?>&thumb=1" 
                               class="btn btn-outline-secondary btn-sm" target="_blank">
                                –ú–∏–Ω–∏–∞—Ç—é—Ä–∞
                            </a>
                        </div>
                        <small class="text-muted d-block mt-1">–û–±–ª–æ–∂–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ñ–∞–π–ª–∞ –∫–Ω–∏–≥–∏</small>
                    </div>
                <?php endif; ?>
            </div>
        </div>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –∫–Ω–∏–≥–∞–º–∏ -->
        <div class="card mt-4">
            <div class="card-body text-center">
                <a href="index.php" class="btn btn-outline-primary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–Ω–∏–≥</a>
                <?php if ($book['author']): ?>
                    <a href="index.php?field=author&q=<?php echo urlencode($book['author']); ?>" class="btn btn-outline-secondary ms-2">
                        –í—Å–µ –∫–Ω–∏–≥–∏ –∞–≤—Ç–æ—Ä–∞
                    </a>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    const coverImage = document.querySelector('.col-md-3 img');
    if (coverImage) {
        coverImage.addEventListener('error', function() {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–æ–∂–∫–∏:', this.src);
            this.style.display = 'none';
            const placeholder = this.nextElementSibling;
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
        });
        
        coverImage.addEventListener('load', function() {
            console.log('–û–±–ª–æ–∂–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', this.src);
        });
    }
});
</script>

<?php
/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –æ–±–ª–æ–∂–∫–∞ –≤ –∫–Ω–∏–≥–µ
 */
function hasBookCover($book) {
    // –î–ª—è FB2 —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–ª–æ–∂–∫–∏
    if (strtolower($book['file_type']) === 'fb2') {
        $content = getBookContent($book);
        if ($content) {
            return Fb2CoverParser::findCover($content) !== false;
        }
    }
    return false;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏
 */
function getBookContent($book) {
    if ($book['archive_path'] && $book['archive_internal_path']) {
        $zip = new ZipArchive();
        if ($zip->open($book['archive_path']) === TRUE) {
            $content = $zip->getFromName($book['archive_internal_path']);
            $zip->close();
            return $content;
        }
    } else {
        return @file_get_contents($book['file_path']);
    }
    return false;
}

require 'templates/footer.php';
?>
./check_server_config.php
<?php
echo "<h1>üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞</h1>";

echo "<h3>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞:</h3>";
echo "DOCUMENT_ROOT: " . $_SERVER['DOCUMENT_ROOT'] . "<br>";
echo "SCRIPT_FILENAME: " . ($_SERVER['SCRIPT_FILENAME'] ?? 'N/A') . "<br>";
echo "REQUEST_URI: " . $_SERVER['REQUEST_URI'] . "<br>";

echo "<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ URL:</h3>";
$testUrls = [
    '/cache/covers/74819_thumb.jpg',
    '/api/cover_simple.php?id=74819&thumb=1',
    '/public/covers/74819_thumb.jpg'
];

foreach ($testUrls as $url) {
    $fullUrl = "http://" . $_SERVER['HTTP_HOST'] . $url;
    echo "<a href='{$fullUrl}' target='_blank'>{$url}</a><br>";
}

echo "<h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π:</h3>";
$includes = [
    'config/config.php' => file_exists(__DIR__ . '/config/config.php'),
    'lib/Database.php' => file_exists(__DIR__ . '/lib/Database.php'),
    'lib/Fb2CoverParser.php' => file_exists(__DIR__ . '/lib/Fb2CoverParser.php')
];

foreach ($includes as $file => $exists) {
    echo "{$file}: " . ($exists ? "‚úÖ –°–£–©–ï–°–¢–í–£–ï–¢" : "‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢") . "<br>";
}
?>
./lib/BookScanner.php
<?php

require_once __DIR__ . '/../config/config.php';

class BookScanner {
    
    public static function runScan() {
        if (!file_exists(Config::SCANNER_PATH)) {
            throw new Exception('Scanner binary not found: ' . Config::SCANNER_PATH);
        }
        
        if (!file_exists(Config::SCANNER_CONFIG)) {
            throw new Exception('Scanner config not found: ' . Config::SCANNER_CONFIG);
        }
        
        $command = escapeshellcmd(Config::SCANNER_PATH) . ' ' . 
                  escapeshellarg(Config::SCANNER_CONFIG) . ' 2>&1';
        
        $output = [];
        $returnCode = 0;
        
        exec($command, $output, $returnCode);
        
        if ($returnCode !== 0) {
            throw new Exception('Scanner failed with code: ' . $returnCode . '. Output: ' . implode("\n", $output));
        }
        
        return $output;
    }
    
    public static function getScanStatus() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫–∞–Ω–µ—Ä
        $output = [];
        exec('pgrep -f "' . basename(Config::SCANNER_PATH) . '"', $output);
        return !empty($output);
    }
}
?>
./lib/OpdsGenerator.php
<?php

require_once __DIR__ . '/Database.php';

class OpdsGenerator {
    private $db;
    private $baseUrl;
    
    public function __construct($baseUrl) {
        $this->db = Database::getInstance();
        $this->baseUrl = rtrim($baseUrl, '/');
    }
    
    public function generateCatalog() {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
        $perPage = 25;
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $xml->writeElement('id', Config::OPDS_ID . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', Config::OPDS_TITLE . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        $xml->writeElement('icon', $this->baseUrl . '/favicon.ico');
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        // –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–º –∫–∞—Ç–∞–ª–æ–≥
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php' . ($page > 1 ? '?page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        $this->addNavigationLinks($xml);
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        $this->addPaginationLinks($xml, $page, $perPage, 'catalog');
        
        // –ö–Ω–∏–≥–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        $books = $this->db->getRecentBooks($perPage, ($page - 1) * $perPage);
        foreach ($books as $book) {
            $this->addBookEntry($xml, $book);
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    public function generateByAuthors($page = 1) {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $perPage = 50; // –ê–≤—Ç–æ—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $xml->writeElement('id', Config::OPDS_ID . ':authors' . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', 'Authors' . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=authors' . ($page > 1 ? '&page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        $this->addBrowseLinks($xml);
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤
        $authors = $this->db->getAuthors();
        $totalAuthors = count($authors);
        $totalPages = ceil($totalAuthors / $perPage);
        
        $this->addPaginationLinks($xml, $page, $perPage, 'authors', $totalPages);
        
        // –ê–≤—Ç–æ—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        $startIndex = ($page - 1) * $perPage;
        $pagedAuthors = array_slice($authors, $startIndex, $perPage);
        
        foreach ($pagedAuthors as $author) {
            if (!empty($author['author'])) {
                $xml->startElement('entry');
                $xml->writeElement('title', htmlspecialchars($author['author']));
                $xml->writeElement('updated', date('c'));
                
                $xml->startElement('link');
                $xml->writeAttribute('rel', 'subsection');
                $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?author=' . urlencode($author['author']));
                $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
                $xml->endElement();
                
                $xml->writeElement('content', 'Books by ' . htmlspecialchars($author['author']));
                $xml->writeAttribute('type', 'text');
                
                $xml->endElement();
            }
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    public function generateByGenres($page = 1) {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $perPage = 50; // –ñ–∞–Ω—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $xml->writeElement('id', Config::OPDS_ID . ':genres' . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', 'Genres' . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=genres' . ($page > 1 ? '&page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        $this->addBrowseLinks($xml);
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∂–∞–Ω—Ä–æ–≤
        $genres = $this->db->getGenresWithCount();
        $totalGenres = count($genres);
        $totalPages = ceil($totalGenres / $perPage);
        
        $this->addPaginationLinks($xml, $page, $perPage, 'genres', $totalPages);
        
        // –ñ–∞–Ω—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        $startIndex = ($page - 1) * $perPage;
        $pagedGenres = array_slice($genres, $startIndex, $perPage);
        
        foreach ($pagedGenres as $genre) {
            if (!empty($genre['genre'])) {
                $xml->startElement('entry');
                
                $genreName = $genre['readable_name'] ?: $genre['genre'];
                $xml->writeElement('title', htmlspecialchars($genreName) . ' (' . $genre['count'] . ')');
                $xml->writeElement('updated', date('c'));
                
                $xml->startElement('link');
                $xml->writeAttribute('rel', 'subsection');
                $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?genre=' . urlencode($genre['genre']));
                $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
                $xml->endElement();
                
                $xml->writeElement('content', $genre['count'] . ' books in ' . htmlspecialchars($genreName));
                $xml->writeAttribute('type', 'text');
                
                $xml->endElement();
            }
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    public function generateByAuthor($author, $page = 1) {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $perPage = 25;
        $booksCount = $this->db->getBooksCountByAuthor($author);
        $totalPages = ceil($booksCount / $perPage);
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $xml->writeElement('id', Config::OPDS_ID . ':author:' . urlencode($author) . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', 'Books by ' . htmlspecialchars($author) . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?author=' . urlencode($author) . ($page > 1 ? '&page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        $this->addBrowseLinks($xml);
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        $this->addPaginationLinks($xml, $page, $perPage, 'author', $totalPages, ['author' => $author]);
        
        $books = $this->db->getBooksByAuthor($author, $page, $perPage);
        foreach ($books as $book) {
            $this->addBookEntry($xml, $book);
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    public function generateByGenre($genre, $page = 1) {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $perPage = 25;
        $booksCount = $this->db->getBooksCountByGenre($genre);
        $totalPages = ceil($booksCount / $perPage);
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $readableGenre = $this->db->getReadableGenre($genre);
        $displayGenre = $readableGenre ?: $genre;
        
        $xml->writeElement('id', Config::OPDS_ID . ':genre:' . urlencode($genre) . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', 'Books in ' . htmlspecialchars($displayGenre) . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?genre=' . urlencode($genre) . ($page > 1 ? '&page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        $this->addBrowseLinks($xml);
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        $this->addPaginationLinks($xml, $page, $perPage, 'genre', $totalPages, ['genre' => $genre]);
        
        $books = $this->db->getBooksByGenre($genre, $page, $perPage);
        foreach ($books as $book) {
            $this->addBookEntry($xml, $book);
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    public function generateSearchResults($query, $page = 1) {
        header('Content-Type: application/atom+xml; charset=utf-8');
        
        $perPage = 25;
        $booksCount = $this->db->getSearchCount($query, 'all');
        $totalPages = ceil($booksCount / $perPage);
        
        $xml = new XMLWriter();
        $xml->openMemory();
        $xml->setIndent(true);
        $xml->setIndentString('  ');
        
        $xml->startDocument('1.0', 'UTF-8');
        
        $xml->startElement('feed');
        $xml->writeAttribute('xmlns', 'http://www.w3.org/2005/Atom');
        $xml->writeAttribute('xmlns:dc', 'http://purl.org/dc/terms/');
        $xml->writeAttribute('xmlns:opds', 'http://opds-spec.org/2010/catalog');
        
        $xml->writeElement('id', Config::OPDS_ID . ':search:' . urlencode($query) . ($page > 1 ? ':page:' . $page : ''));
        $xml->writeElement('title', 'Search: ' . htmlspecialchars($query) . ($page > 1 ? ' - Page ' . $page : ''));
        $xml->writeElement('updated', date('c'));
        
        $xml->startElement('author');
        $xml->writeElement('name', Config::OPDS_AUTHOR);
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'self');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?search=' . urlencode($query) . ($page > 1 ? '&page=' . $page : ''));
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
        
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        $this->addPaginationLinks($xml, $page, $perPage, 'search', $totalPages, ['search' => $query]);
        
        $books = $this->db->searchBooks($query, 'all', $page, $perPage);
        foreach ($books as $book) {
            $this->addBookEntry($xml, $book);
        }
        
        $xml->endElement();
        
        return $xml->outputMemory();
    }
    
    private function addNavigationLinks($xml) {
        // –ù–æ–≤—ã–µ –∫–Ω–∏–≥–∏
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'http://opds-spec.org/sort/new');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->writeElement('title', 'Newest Books');
        $xml->endElement();
        
        // –ü–æ –∞–≤—Ç–æ—Ä–∞–º
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'subsection');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=authors');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->writeElement('title', 'Browse by Authors');
        $xml->endElement();
        
        // –ü–æ –∂–∞–Ω—Ä–∞–º
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'subsection');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=genres');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->writeElement('title', 'Browse by Genres');
        $xml->endElement();
        
        // –ü–æ–∏—Å–∫
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'search');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?search={searchTerms}');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->writeAttribute('opds:searchType', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->endElement();
    }
    
    private function addBrowseLinks($xml) {
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'subsection');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=authors');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->writeElement('title', 'Authors');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'subsection');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?by=genres');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=navigation');
        $xml->writeElement('title', 'Genres');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'start');
        $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php');
        $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog;kind=acquisition');
        $xml->writeElement('title', 'New Books');
        $xml->endElement();
    }
    
    private function addPaginationLinks($xml, $currentPage, $perPage, $type, $totalPages = null, $params = []) {
        if ($currentPage > 1) {
            $prevParams = http_build_query(array_merge($params, ['page' => $currentPage - 1]));
            $xml->startElement('link');
            $xml->writeAttribute('rel', 'previous');
            $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?' . $prevParams);
            $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog');
            $xml->endElement();
        }
        
        if ($totalPages && $currentPage < $totalPages) {
            $nextParams = http_build_query(array_merge($params, ['page' => $currentPage + 1]));
            $xml->startElement('link');
            $xml->writeAttribute('rel', 'next');
            $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?' . $nextParams);
            $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog');
            $xml->endElement();
        }
        
        // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        if ($currentPage > 2) {
            $firstParams = http_build_query(array_merge($params, ['page' => 1]));
            $xml->startElement('link');
            $xml->writeAttribute('rel', 'first');
            $xml->writeAttribute('href', $this->baseUrl . '/api/opds.php?' . $firstParams);
            $xml->writeAttribute('type', 'application/atom+xml;profile=opds-catalog');
            $xml->endElement();
        }
    }
    
    private function addBookEntry($xml, $book) {
        $xml->startElement('entry');
        
        $xml->writeElement('id', Config::OPDS_ID . ':book:' . $book['id']);
        $xml->writeElement('title', htmlspecialchars($book['title'] ?: 'Unknown Title'));
        $xml->writeElement('updated', date('c', strtotime($book['added_date'])));
        
        if ($book['author']) {
            $xml->startElement('author');
            $xml->writeElement('name', htmlspecialchars($book['author']));
            $xml->endElement();
        }
        
        // –û–ø–∏—Å–∞–Ω–∏–µ
        if ($book['description']) {
            $description = substr($book['description'], 0, 500);
            $xml->writeElement('summary', htmlspecialchars($description));
            $xml->writeAttribute('type', 'text');
        }
        
        // –û–±–ª–æ–∂–∫–∞
        $coverUrl = $this->baseUrl . '/api/cover_direct.php?id=' . $book['id'];
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'http://opds-spec.org/image');
        $xml->writeAttribute('href', $coverUrl);
        $xml->writeAttribute('type', 'image/jpeg');
        $xml->endElement();
        
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'http://opds-spec.org/image/thumbnail');
        $xml->writeAttribute('href', $coverUrl . '&thumb=1');
        $xml->writeAttribute('type', 'image/jpeg');
        $xml->endElement();
        
        // –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è - –û–ß–ï–ù–¨ –í–ê–ñ–ù–û –¥–ª—è FBReader
        $downloadUrl = $this->baseUrl . '/api/download.php?id=' . $book['id'];
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'http://opds-spec.org/acquisition/open-access');
        $xml->writeAttribute('href', $downloadUrl);
        $xml->writeAttribute('type', $this->getMimeType($book['file_type']));
        $xml->endElement();
        
        // –î—É–±–ª–∏—Ä—É—é—â–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        $xml->startElement('link');
        $xml->writeAttribute('rel', 'http://opds-spec.org/acquisition');
        $xml->writeAttribute('href', $downloadUrl);
        $xml->writeAttribute('type', $this->getMimeType($book['file_type']));
        $xml->endElement();
        
        // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
        if ($book['genre']) {
            $xml->startElement('category');
            $xml->writeAttribute('term', htmlspecialchars($book['genre']));
            $xml->writeAttribute('label', htmlspecialchars($book['genre']));
            $xml->endElement();
        }
        
        if ($book['language']) {
            $xml->writeElement('dc:language', htmlspecialchars($book['language']));
        }
        
        if ($book['publisher']) {
            $xml->writeElement('dc:publisher', htmlspecialchars($book['publisher']));
        }
        
        if ($book['year']) {
            $xml->writeElement('dc:issued', $book['year']);
        }
        
        $xml->endElement(); // entry
    }
    
    private function getMimeType($fileType) {
        $mimeTypes = [
            'epub' => 'application/epub+zip',
            'pdf' => 'application/pdf',
            'fb2' => 'application/x-fictionbook+xml',
            'mobi' => 'application/x-mobipocket-ebook',
            'txt' => 'text/plain',
            'zip' => 'application/zip',
            'rar' => 'application/x-rar-compressed',
            '7z' => 'application/x-7z-compressed'
        ];
        
        return $mimeTypes[strtolower($fileType)] ?? 'application/octet-stream';
    }
}
?>
./lib/Database.php
<?php

require_once __DIR__ . '/../config/config.php';

class Database {
    private $pdo;
    private static $instance = null;
    
    private function __construct() {
        try {
            switch (Config::DB_TYPE) {
                case 'sqlite':
                    $dsn = 'sqlite:' . Config::DB_PATH;
                    $this->pdo = new PDO($dsn);
                    break;
                case 'mysql':
                    $dsn = 'mysql:host=' . Config::DB_HOST . ';dbname=' . Config::DB_NAME . ';charset=utf8';
                    $this->pdo = new PDO($dsn, Config::DB_USER, Config::DB_PASS);
                    break;
                case 'pgsql':
                    $dsn = 'pgsql:host=' . Config::DB_HOST . ';dbname=' . Config::DB_NAME;
                    $this->pdo = new PDO($dsn, Config::DB_USER, Config::DB_PASS);
                    break;
                default:
                    throw new Exception('Unsupported database type');
            }
            
            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $this->pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
            
            // –î–ª—è SQLite –≤–∫–ª—é—á–∞–µ–º foreign keys
            if (Config::DB_TYPE === 'sqlite') {
                $this->pdo->exec('PRAGMA foreign_keys = ON');
            }
            
        } catch (PDOException $e) {
            die('Database connection failed: ' . $e->getMessage());
        }
    }
    
    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function getConnection() {
        return $this->pdo;
    }
    
    /**
     * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
     */
    private function executeQuery($sql, $params = []) {
        $stmt = $this->pdo->prepare($sql);
        
        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
        foreach ($params as $index => $value) {
            $paramType = PDO::PARAM_STR;
            if (is_int($value)) {
                $paramType = PDO::PARAM_INT;
            } elseif (is_bool($value)) {
                $paramType = PDO::PARAM_BOOL;
            } elseif (is_null($value)) {
                $paramType = PDO::PARAM_NULL;
            }
            
            $stmt->bindValue($index + 1, $value, $paramType);
        }
        
        $stmt->execute();
        return $stmt;
    }
    
    // –ü–æ–∏—Å–∫ –∫–Ω–∏–≥
    public function searchBooks($query, $field = 'all', $page = 1, $perPage = Config::ITEMS_PER_PAGE) {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        $params = [];
        
        $sql = "SELECT * FROM books WHERE 1=1";
        
        if (!empty($query)) {
            switch ($field) {
                case 'author':
                    $sql .= " AND author LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'title':
                    $sql .= " AND title LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'genre':
                    $sql .= " AND genre LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'series':
                    $sql .= " AND series LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'all':
                default:
                    $sql .= " AND (title LIKE ? OR author LIKE ? OR genre LIKE ? OR series LIKE ?)";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    break;
            }
        }
        
        $sql .= " ORDER BY author, title LIMIT ? OFFSET ?";
        $params[] = $perPage;
        $params[] = $offset;
        
        $stmt = $this->executeQuery($sql, $params);
        return $stmt->fetchAll();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥—É –ø–æ ID
    public function getBook($id) {
        $stmt = $this->executeQuery("SELECT * FROM books WHERE id = ?", [$id]);
        return $stmt->fetch();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π)
    public function getRecentBooks($limit = 10, $offset = 0) {
        $limit = (int)$limit;
        $offset = (int)$offset;
        
        $sql = "SELECT * FROM books ORDER BY added_date DESC LIMIT ? OFFSET ?";
        $stmt = $this->executeQuery($sql, [$limit, $offset]);
        return $stmt->fetchAll();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –¥–ª—è –ø–æ–∏—Å–∫–∞
    public function getSearchCount($query, $field = 'all') {
        $params = [];
        $sql = "SELECT COUNT(*) as count FROM books WHERE 1=1";
        
        if (!empty($query)) {
            switch ($field) {
                case 'author':
                    $sql .= " AND author LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'title':
                    $sql .= " AND title LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'genre':
                    $sql .= " AND genre LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'series':
                    $sql .= " AND series LIKE ?";
                    $params[] = "%$query%";
                    break;
                case 'all':
                default:
                    $sql .= " AND (title LIKE ? OR author LIKE ? OR genre LIKE ? OR series LIKE ?)";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    $params[] = "%$query%";
                    break;
            }
        }
        
        $stmt = $this->executeQuery($sql, $params);
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–≤—Ç–æ—Ä—ã
    public function getAuthors() {
        $stmt = $this->executeQuery(
            "SELECT DISTINCT author FROM books WHERE author IS NOT NULL AND author != '' ORDER BY author"
        );
        return $stmt->fetchAll();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∂–∞–Ω—Ä—ã
    public function getGenres() {
        $stmt = $this->executeQuery(
            "SELECT DISTINCT genre FROM books WHERE genre IS NOT NULL AND genre != '' ORDER BY genre"
        );
        return $stmt->fetchAll();
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–µ—Ä–∏–∏
    public function getSeries() {
        $stmt = $this->executeQuery(
            "SELECT DISTINCT series FROM books WHERE series IS NOT NULL AND series != '' ORDER BY series"
        );
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–ª–ª–µ–∫—Ü–∏–∏
     */
    public function getCollectionStats() {
        $stats = [];
        
        // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books");
        $result = $stmt->fetch();
        $stats['total_books'] = $result['count'];
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ—Ä–æ–≤
        $stmt = $this->executeQuery(
            "SELECT COUNT(DISTINCT author) as count FROM books WHERE author IS NOT NULL AND author != ''"
        );
        $result = $stmt->fetch();
        $stats['total_authors'] = $result['count'];
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∞–Ω—Ä–æ–≤
        $stmt = $this->executeQuery(
            "SELECT COUNT(DISTINCT genre) as count FROM books WHERE genre IS NOT NULL AND genre != ''"
        );
        $result = $stmt->fetch();
        $stats['total_genres'] = $result['count'];
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–∏–π
        $stmt = $this->executeQuery(
            "SELECT COUNT(DISTINCT series) as count FROM books WHERE series IS NOT NULL AND series != ''"
        );
        $result = $stmt->fetch();
        $stats['total_series'] = $result['count'];
        
        // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        $stmt = $this->executeQuery("SELECT MAX(added_date) as last_update FROM books");
        $result = $stmt->fetch();
        $stats['last_update'] = $result['last_update'];
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–æ—Ä–º–∞—Ç–∞–º —Ñ–∞–π–ª–æ–≤
        $stmt = $this->executeQuery("
            SELECT file_type, COUNT(*) as count 
            FROM books 
            WHERE file_type IS NOT NULL 
            GROUP BY file_type 
            ORDER BY count DESC
        ");
        $stats['file_types'] = $stmt->fetchAll();
        
        // –ö–Ω–∏–≥–∏ –≤ –∞—Ä—Ö–∏–≤–∞—Ö
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books WHERE archive_path IS NOT NULL");
        $result = $stmt->fetch();
        $stats['books_in_archives'] = $result['count'];
        
        return $stats;
    }
    
    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∂–∞–Ω—Ä FB2 –≤ —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É—è –º–∞–ø–ø–∏–Ω–≥ –∏–∑ config.php
     */
    public function getReadableGenre($genre) {
        if (empty($genre)) {
            return null;
        }
        
        // –ï—Å–ª–∏ –∂–∞–Ω—Ä —É–∂–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if (in_array($genre, array_values(Config::FB2_GENRES))) {
            return $genre;
        }
        
        // –ò—â–µ–º –≤ –º–∞–ø–ø–∏–Ω–≥–µ FB2 –∂–∞–Ω—Ä–æ–≤ –∏–∑ config.php
        if (isset(Config::FB2_GENRES[$genre])) {
            return Config::FB2_GENRES[$genre];
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –º–∞–ø–ø–∏–Ω–≥–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        // —Å –ø–µ—Ä–≤–æ–π –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤–æ–π –∏ –∑–∞–º–µ–Ω–æ–π –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
        return ucfirst(str_replace('_', ' ', $genre));
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∂–∞–Ω—Ä—ã —Å –∏—Ö —á–∞—Å—Ç–æ—Ç–æ–π –∏ —á–∏—Ç–∞–µ–º—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
     */
    public function getGenresWithCount() {
        $stmt = $this->executeQuery("
            SELECT genre, COUNT(*) as count 
            FROM books 
            WHERE genre IS NOT NULL AND genre != '' 
            GROUP BY genre 
            ORDER BY count DESC, genre
        ");
        $genres = $stmt->fetchAll();
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∂–∞–Ω—Ä–æ–≤ —á–µ—Ä–µ–∑ –º–∞–ø–ø–∏–Ω–≥ –∏–∑ config.php
        foreach ($genres as &$genre) {
            $genre['readable_name'] = $this->getReadableGenre($genre['genre']);
        }
        
        return $genres;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –∞–≤—Ç–æ—Ä–æ–≤
     */
    public function getTopAuthors($limit = 20) {
        $limit = (int)$limit;
        
        $stmt = $this->executeQuery("
            SELECT author, COUNT(*) as count 
            FROM books 
            WHERE author IS NOT NULL AND author != '' 
            GROUP BY author 
            ORDER BY count DESC, author
            LIMIT ?
        ", [$limit]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø —Å–µ—Ä–∏–π
     */
    public function getTopSeries($limit = 20) {
        $limit = (int)$limit;
        
        $stmt = $this->executeQuery("
            SELECT series, COUNT(*) as count 
            FROM books 
            WHERE series IS NOT NULL AND series != '' 
            GROUP BY series 
            ORDER BY count DESC, series
            LIMIT ?
        ", [$limit]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏ –ø–æ –∞–≤—Ç–æ—Ä—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    public function getBooksByAuthor($author, $page = 1, $perPage = 20) {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        
        $stmt = $this->executeQuery("
            SELECT * FROM books 
            WHERE author = ? 
            ORDER BY series, series_number, title
            LIMIT ? OFFSET ?
        ", [$author, $perPage, $offset]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –ø–æ –∞–≤—Ç–æ—Ä—É
     */
    public function getBooksCountByAuthor($author) {
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books WHERE author = ?", [$author]);
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    public function getBooksByGenre($genre, $page = 1, $perPage = 20) {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        
        $stmt = $this->executeQuery("
            SELECT * FROM books 
            WHERE genre = ? 
            ORDER BY author, title
            LIMIT ? OFFSET ?
        ", [$genre, $perPage, $offset]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –ø–æ –∂–∞–Ω—Ä—É
     */
    public function getBooksCountByGenre($genre) {
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books WHERE genre = ?", [$genre]);
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏ –ø–æ —Å–µ—Ä–∏–∏ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    public function getBooksBySeries($series, $page = 1, $perPage = 20) {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        
        $stmt = $this->executeQuery("
            SELECT * FROM books 
            WHERE series = ? 
            ORDER BY series_number, title
            LIMIT ? OFFSET ?
        ", [$series, $perPage, $offset]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –ø–æ —Å–µ—Ä–∏–∏
     */
    public function getBooksCountBySeries($series) {
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books WHERE series = ?", [$series]);
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–µ –∫–Ω–∏–≥–∏
     */
    public function getRandomBooks($limit = 10) {
        $limit = (int)$limit;
        
        // –î–ª—è MySQL –∏—Å–ø–æ–ª—å–∑—É–µ–º RAND(), –¥–ª—è SQLite - RANDOM()
        $randomFunc = Config::DB_TYPE === 'mysql' ? 'RAND()' : 'RANDOM()';
        
        $stmt = $this->executeQuery("
            SELECT * FROM books 
            ORDER BY {$randomFunc} 
            LIMIT ?
        ", [$limit]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π
     */
    public function getRecentBooksByDays($days = 5) {
        $days = (int)$days;
        
        // –î–ª—è —Ä–∞–∑–Ω—ã—Ö –°–£–ë–î —Ä–∞–∑–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–∞—Ç
        if (Config::DB_TYPE === 'mysql') {
            $stmt = $this->executeQuery("
                SELECT * FROM books 
                WHERE added_date >= DATE_SUB(NOW(), INTERVAL ? DAY) 
                ORDER BY added_date DESC
            ", [$days]);
        } else {
            $stmt = $this->executeQuery("
                SELECT * FROM books 
                WHERE added_date >= datetime('now', '-? days') 
                ORDER BY added_date DESC
            ", [$days]);
        }
        
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—è–º —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    public function advancedSearch($conditions, $page = 1, $perPage = Config::ITEMS_PER_PAGE) {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        $params = [];
        $sql = "SELECT * FROM books WHERE 1=1";
        
        if (!empty($conditions['title'])) {
            $sql .= " AND title LIKE ?";
            $params[] = "%{$conditions['title']}%";
        }
        
        if (!empty($conditions['author'])) {
            $sql .= " AND author LIKE ?";
            $params[] = "%{$conditions['author']}%";
        }
        
        if (!empty($conditions['genre'])) {
            $sql .= " AND genre LIKE ?";
            $params[] = "%{$conditions['genre']}%";
        }
        
        if (!empty($conditions['series'])) {
            $sql .= " AND series LIKE ?";
            $params[] = "%{$conditions['series']}%";
        }
        
        if (!empty($conditions['year_from'])) {
            $sql .= " AND year >= ?";
            $params[] = $conditions['year_from'];
        }
        
        if (!empty($conditions['year_to'])) {
            $sql .= " AND year <= ?";
            $params[] = $conditions['year_to'];
        }
        
        if (!empty($conditions['language'])) {
            $sql .= " AND language = ?";
            $params[] = $conditions['language'];
        }
        
        $sql .= " ORDER BY author, title LIMIT ? OFFSET ?";
        $params[] = $perPage;
        $params[] = $offset;
        
        $stmt = $this->executeQuery($sql, $params);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
     */
    public function getAdvancedSearchCount($conditions) {
        $params = [];
        $sql = "SELECT COUNT(*) as count FROM books WHERE 1=1";
        
        if (!empty($conditions['title'])) {
            $sql .= " AND title LIKE ?";
            $params[] = "%{$conditions['title']}%";
        }
        
        if (!empty($conditions['author'])) {
            $sql .= " AND author LIKE ?";
            $params[] = "%{$conditions['author']}%";
        }
        
        if (!empty($conditions['genre'])) {
            $sql .= " AND genre LIKE ?";
            $params[] = "%{$conditions['genre']}%";
        }
        
        if (!empty($conditions['series'])) {
            $sql .= " AND series LIKE ?";
            $params[] = "%{$conditions['series']}%";
        }
        
        if (!empty($conditions['year_from'])) {
            $sql .= " AND year >= ?";
            $params[] = $conditions['year_from'];
        }
        
        if (!empty($conditions['year_to'])) {
            $sql .= " AND year <= ?";
            $params[] = $conditions['year_to'];
        }
        
        if (!empty($conditions['language'])) {
            $sql .= " AND language = ?";
            $params[] = $conditions['language'];
        }
        
        $stmt = $this->executeQuery($sql, $params);
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    /**
     * –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ
     */
    public function updateBook($id, $data) {
        $allowedFields = ['title', 'author', 'genre', 'series', 'series_number', 'year', 'language', 'publisher', 'description'];
        $setParts = [];
        $params = [];
        
        foreach ($allowedFields as $field) {
            if (isset($data[$field])) {
                $setParts[] = "$field = ?";
                $params[] = $data[$field];
            }
        }
        
        if (empty($setParts)) {
            return false;
        }
        
        // –î–ª—è —Ä–∞–∑–Ω—ã—Ö –°–£–ë–î —Ä–∞–∑–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
        if (Config::DB_TYPE === 'mysql') {
            $setParts[] = "last_modified = NOW()";
        } else {
            $setParts[] = "last_modified = CURRENT_TIMESTAMP";
        }
        
        $sql = "UPDATE books SET " . implode(', ', $setParts) . " WHERE id = ?";
        $params[] = $id;
        
        $stmt = $this->executeQuery($sql, $params);
        return $stmt->rowCount() > 0;
    }
    
    /**
     * –£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É
     */
    public function deleteBook($id) {
        $stmt = $this->executeQuery("DELETE FROM books WHERE id = ?", [$id]);
        return $stmt->rowCount() > 0;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
     */
    public function bookExists($filePath, $archivePath = null, $internalPath = null) {
        $sql = "SELECT id FROM books WHERE file_path = ?";
        $params = [$filePath];
        
        if ($archivePath) {
            $sql .= " AND archive_path = ?";
            $params[] = $archivePath;
        } else {
            $sql .= " AND archive_path IS NULL";
        }
        
        if ($internalPath) {
            $sql .= " AND archive_internal_path = ?";
            $params[] = $internalPath;
        } else {
            $sql .= " AND archive_internal_path IS NULL";
        }
        
        $stmt = $this->executeQuery($sql, $params);
        return $stmt->fetch() !== false;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
     */
    public function getTotalBooksCount() {
        $stmt = $this->executeQuery("SELECT COUNT(*) as count FROM books");
        $result = $stmt->fetch();
        return $result['count'];
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∫–Ω–∏–≥–∏ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
     */
    public function getBooksWithPagination($page = 1, $perPage = 20, $orderBy = 'added_date', $orderDir = 'DESC') {
        $offset = (int)(($page - 1) * $perPage);
        $perPage = (int)$perPage;
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        $allowedOrders = ['added_date', 'title', 'author', 'year'];
        $allowedDirs = ['ASC', 'DESC'];
        
        $orderBy = in_array($orderBy, $allowedOrders) ? $orderBy : 'added_date';
        $orderDir = in_array($orderDir, $allowedDirs) ? $orderDir : 'DESC';
        
        $stmt = $this->executeQuery("
            SELECT * FROM books 
            ORDER BY {$orderBy} {$orderDir}
            LIMIT ? OFFSET ?
        ", [$perPage, $offset]);
        return $stmt->fetchAll();
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞ –¥–ª—è –∫–Ω–∏–≥–∏ (—É–¥–æ–±–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤)
     */
    public function getBookReadableGenre($bookId) {
        $book = $this->getBook($bookId);
        if ($book && $book['genre']) {
            return $this->getReadableGenre($book['genre']);
        }
        return null;
    }
    
    /**
     * –ü–æ–∏—Å–∫ –ø–æ —á–∏—Ç–∞–µ–º—ã–º –Ω–∞–∑–≤–∞–Ω–∏—è–º –∂–∞–Ω—Ä–æ–≤
     */
    public function searchByReadableGenre($readableGenre) {
        // –ò—â–µ–º –æ–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ - –∏–∑ —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –∫–æ–¥
        $genreCode = array_search($readableGenre, Config::FB2_GENRES);
        if ($genreCode !== false) {
            return $this->getBooksByGenre($genreCode, 1, 100);
        }
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        $stmt = $this->executeQuery("
            SELECT b.* 
            FROM books b 
            WHERE b.genre IN (
                SELECT genre FROM books 
                WHERE genre LIKE ? 
                GROUP BY genre
            )
            ORDER BY b.author, b.title
            LIMIT 100
        ", ["%$readableGenre%"]);
        return $stmt->fetchAll();
    }
}
./lib/Fb2CoverParser.php
<?php

class Fb2CoverParser {
    
    /**
     * –ù–∞–π—Ç–∏ –æ–±–ª–æ–∂–∫—É –≤ FB2 —Å–æ–¥–µ—Ä–∂–∏–º–æ–º
     */
    public static function findCover($content) {
        if (empty($content)) {
            return false;
        }
        
        // –ú–µ—Ç–æ–¥ 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π coverpage —Å l:href
        if (preg_match('/<coverpage>.*?<image[^>]*l:href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is', $content, $matches)) {
            $coverId = $matches[1];
            $imageData = self::extractBinaryData($content, $coverId);
            if ($imageData) {
                return $imageData;
            }
        }
        
        // –ú–µ—Ç–æ–¥ 2: Coverpage —Å xlink:href
        if (preg_match('/<coverpage>.*?<image[^>]*xlink:href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is', $content, $matches)) {
            $coverId = $matches[1];
            $imageData = self::extractBinaryData($content, $coverId);
            if ($imageData) {
                return $imageData;
            }
        }
        
        // –ú–µ—Ç–æ–¥ 3: –ü—Ä–æ—Å—Ç–æ–π coverpage
        if (preg_match('/<coverpage>.*?<image[^>]*href[[:space:]]*=[[:space:]]*["\']#([^"\']+)["\'][^>]*>.*?<\/coverpage>/is', $content, $matches)) {
            $coverId = $matches[1];
            $imageData = self::extractBinaryData($content, $coverId);
            if ($imageData) {
                return $imageData;
            }
        }
        
        // –ú–µ—Ç–æ–¥ 4: –ò—â–µ–º –ª—é–±—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
        $imageData = self::findAnyImageBinary($content);
        if ($imageData) {
            return $imageData;
        }
        
        return false;
    }
    
    /**
     * –ò–∑–≤–ª–µ—á—å –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ ID
     */
    private static function extractBinaryData($content, $binaryId) {
        // –ü–∞—Ç—Ç–µ—Ä–Ω 1: —Å content-type
        $pattern1 = '/<binary[^>]*id[[:space:]]*=[[:space:]]*["\']' . preg_quote($binaryId, '/') . '["\'][^>]*content-type[[:space:]]*=[[:space:]]*["\']([^"\']+)["\'][^>]*>([^<]*)<\/binary>/is';
        
        // –ü–∞—Ç—Ç–µ—Ä–Ω 2: –±–µ–∑ content-type
        $pattern2 = '/<binary[^>]*id[[:space:]]*=[[:space:]]*["\']' . preg_quote($binaryId, '/') . '["\'][^>]*>([^<]*)<\/binary>/is';
        
        if (preg_match($pattern1, $content, $matches)) {
            return base64_decode(trim($matches[2]));
        }
        
        if (preg_match($pattern2, $content, $matches)) {
            return base64_decode(trim($matches[1]));
        }
        
        return false;
    }
    
    /**
     * –ù–∞–π—Ç–∏ –ª—é–±—ã–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
     */
    private static function findAnyImageBinary($content) {
        // –ò—â–µ–º –≤—Å–µ binary —Ç–µ–≥–∏
        if (preg_match_all('/<binary[^>]*>([^<]*)<\/binary>/is', $content, $allBinaries)) {
            foreach ($allBinaries[0] as $index => $binaryTag) {
                $binaryData = base64_decode(trim($allBinaries[1][$index]));
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (self::isValidImage($binaryData)) {
                    return $binaryData;
                }
            }
        }
        
        return false;
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —è–≤–ª—è—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
     */
    private static function isValidImage($data) {
        if (empty($data) || strlen($data) < 100) {
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        $signatures = [
            'ffd8ff' => 'jpg',      // JPEG
            '89504e47' => 'png',    // PNG
            '47494638' => 'gif',    // GIF
            '424d' => 'bmp',        // BMP
            '52494646' => 'webp',   // WEBP
        ];
        
        $hex = bin2hex(substr($data, 0, 4));
        foreach ($signatures as $signature => $type) {
            if (strpos($hex, $signature) === 0) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
     */
    public static function getImageInfo($imageData) {
        if (!self::isValidImage($imageData)) {
            return false;
        }
        
        $tempFile = tempnam(sys_get_temp_dir(), 'fb2_img_');
        file_put_contents($tempFile, $imageData);
        
        $info = getimagesize($tempFile);
        unlink($tempFile);
        
        if ($info) {
            return [
                'width' => $info[0],
                'height' => $info[1],
                'type' => $info[2],
                'mime' => $info['mime'],
                'size' => strlen($imageData)
            ];
        }
        
        return false;
    }
}
?>
./stats.php
<?php

require_once 'config/config.php';
require_once 'lib/Database.php';

$db = Database::getInstance();
$stats = $db->getCollectionStats();
$genres = $db->getGenresWithCount();

require 'templates/header.php';
?>

<div class="row">
    <div class="col-12">
        <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h1>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h4><?php echo number_format($stats['total_books'], 0, '', ' '); ?></h4>
                        <p class="card-text">–ö–Ω–∏–≥ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h4><?php echo number_format($stats['total_authors'], 0, '', ' '); ?></h4>
                        <p class="card-text">–ê–≤—Ç–æ—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h4><?php echo number_format($stats['total_genres'], 0, '', ' '); ?></h4>
                        <p class="card-text">–ñ–∞–Ω—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h4><?php echo number_format($stats['total_series'], 0, '', ' '); ?></h4>
                        <p class="card-text">–°–µ—Ä–∏–π</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∂–∞–Ω—Ä–∞–º -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∂–∞–Ω—Ä–∞–º</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <?php 
                    $counter = 0;
                    foreach ($genres as $genre): 
                        if ($counter % 4 === 0 && $counter > 0): ?>
                            </div><div class="row">
                        <?php endif; ?>
                        <div class="col-md-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    <a href="index.php?field=genre&q=<?php echo urlencode($genre['genre']); ?>" 
                                       class="text-decoration-none">
                                        <?php echo htmlspecialchars($genre['readable_name']); ?>
                                    </a>
                                </span>
                                <span class="badge bg-secondary"><?php echo $genre['count']; ?></span>
                            </div>
                        </div>
                    <?php 
                        $counter++;
                    endforeach; 
                    ?>
                </div>
            </div>
        </div>
        
        <?php if ($stats['last_update']): ?>
            <div class="mt-3 text-end">
                <small class="text-muted">
                    –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: <?php echo date('d.m.Y H:i', strtotime($stats['last_update'])); ?>
                </small>
            </div>
        <?php endif; ?>
    </div>
</div>

<?php require 'templates/footer.php'; ?>
./index.php
<?php

require_once 'config/config.php';
require_once 'lib/Database.php';
require_once 'lib/Fb2CoverParser.php';

$db = Database::getInstance();
$page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
$searchQuery = $_GET['q'] ?? '';
$searchField = $_GET['field'] ?? 'all';

if (!empty($searchQuery)) {
    $books = $db->searchBooks($searchQuery, $searchField, $page);
    $totalBooks = $db->getSearchCount($searchQuery, $searchField);
} else {
    $books = $db->getRecentBooks(Config::ITEMS_PER_PAGE);
    $totalBooks = 0;
}

$totalPages = ceil($totalBooks / Config::ITEMS_PER_PAGE);

require 'templates/header.php';
?>

<div class="row">
    <div class="col-md-3">
        <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="card search-form">
            <div class="card-body">
                <h5 class="card-title">–ü–æ–∏—Å–∫ –∫–Ω–∏–≥</h5>
                <form method="get" action="index.php">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="q" value="<?php echo htmlspecialchars($searchQuery); ?>" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å...">
                    </div>
                    <div class="mb-3">
                        <select class="form-select" name="field">
                            <option value="all" <?php echo $searchField === 'all' ? 'selected' : ''; ?>>–í–µ–∑–¥–µ</option>
                            <option value="title" <?php echo $searchField === 'title' ? 'selected' : ''; ?>>–ù–∞–∑–≤–∞–Ω–∏–µ</option>
                            <option value="author" <?php echo $searchField === 'author' ? 'selected' : ''; ?>>–ê–≤—Ç–æ—Ä</option>
                            <option value="genre" <?php echo $searchField === 'genre' ? 'selected' : ''; ?>>–ñ–∞–Ω—Ä</option>
                            <option value="series" <?php echo $searchField === 'series' ? 'selected' : ''; ?>>–°–µ—Ä–∏—è</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">–ù–∞–π—Ç–∏</button>
                </form>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫</h5>
                <ul class="list-unstyled">
                    <li><a href="index.php?field=author&q=">–ü–æ –∞–≤—Ç–æ—Ä–∞–º</a></li>
                    <li><a href="index.php?field=genre&q=">–ü–æ –∂–∞–Ω—Ä–∞–º</a></li>
                    <li><a href="index.php?field=series&q=">–ü–æ —Å–µ—Ä–∏—è–º</a></li>
                </ul>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                <?php
                try {
                    $stats = $db->getCollectionStats();
                    ?>
                    <small class="text-muted">
                        –ö–Ω–∏–≥: <?php echo number_format($stats['total_books'], 0, '', ' '); ?><br>
                        –ê–≤—Ç–æ—Ä–æ–≤: <?php echo number_format($stats['total_authors'], 0, '', ' '); ?><br>
                        –ñ–∞–Ω—Ä–æ–≤: <?php echo number_format($stats['total_genres'], 0, '', ' '); ?>
                    </small>
                    <?php
                } catch (Exception $e) {
                    echo '<small class="text-muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</small>';
                }
                ?>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <h2>
            <?php if (!empty($searchQuery)): ?>
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "<?php echo htmlspecialchars($searchQuery); ?>"
                <small class="text-muted">(–Ω–∞–π–¥–µ–Ω–æ: <?php echo $totalBooks; ?>)</small>
            <?php else: ?>
                –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
            <?php endif; ?>
        </h2>

        <?php if (empty($books)): ?>
            <div class="alert alert-info">
                <?php if (!empty($searchQuery)): ?>
                    –ö–Ω–∏–≥–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É "<?php echo htmlspecialchars($searchQuery); ?>" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                <?php else: ?>
                    –í –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç –∫–Ω–∏–≥.
                <?php endif; ?>
            </div>
        <?php else: ?>
            <div class="row">
                <?php foreach ($books as $book): ?>
                    <div class="col-md-6 book-card">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-3">
                                        <?php
                                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±–ª–æ–∂–∫—É –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–Ω–∏–≥–∏
                                        $coverUrl = "./api/cover_direct.php?id=" . $book['id'] . "&thumb=1";
                                        $hasCover = hasBookCover($book);
                                        ?>
                                        
                                        <?php if ($hasCover): ?>
                                            <img src="<?php echo $coverUrl; ?>" 
                                                 class="book-cover img-fluid" 
                                                 alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏ <?php echo htmlspecialchars($book['title']); ?>"
                                                 style="max-width: 100px; height: auto;"
                                                 onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                 loading="lazy">
                                        <?php else: ?>
                                            <div class="book-cover-placeholder bg-light d-flex align-items-center justify-content-center" style="width:100px; height:150px;">
                                                <small class="text-muted">–ù–µ—Ç –æ–±–ª–æ–∂–∫–∏</small>
                                            </div>
                                        <?php endif; ?>
                                    </div>
                                    <div class="col-9">
                                        <h6 class="card-title">
                                            <a href="book_detail.php?id=<?php echo $book['id']; ?>" class="text-decoration-none">
                                                <?php echo htmlspecialchars($book['title'] ?: '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'); ?>
                                            </a>
                                        </h6>
                                        
                                        <?php if ($book['author']): ?>
                                            <p class="card-text mb-1">
                                                <small class="text-muted">
                                                    <strong>–ê–≤—Ç–æ—Ä:</strong> 
                                                    <a href="index.php?field=author&q=<?php echo urlencode($book['author']); ?>" class="text-decoration-none">
                                                        <?php echo htmlspecialchars($book['author']); ?>
                                                    </a>
                                                </small>
                                            </p>
                                        <?php endif; ?>
                                        
                                        <?php if ($book['series']): ?>
                                            <p class="card-text mb-1">
                                                <small>
                                                    <strong>–°–µ—Ä–∏—è:</strong> 
                                                    <a href="index.php?field=series&q=<?php echo urlencode($book['series']); ?>" class="text-decoration-none">
                                                        <?php echo htmlspecialchars($book['series']); ?>
                                                    </a>
                                                    <?php if ($book['series_number']): ?>
                                                        <span class="badge bg-secondary ms-1">#<?php echo $book['series_number']; ?></span>
                                                    <?php endif; ?>
                                                </small>
                                            </p>
                                        <?php endif; ?>

                                        <?php if ($book['genre']): ?>
                                            <p class="card-text mb-1">
                                                <small>
                                                    <strong>–ñ–∞–Ω—Ä:</strong> 
                                                    <?php 
                                                    $readableGenre = $db->getReadableGenre($book['genre']);
                                                    echo htmlspecialchars($readableGenre ?: $book['genre']); 
                                                    ?>
                                                </small>
                                            </p>
                                        <?php endif; ?>

                                        <?php if ($book['year']): ?>
                                            <p class="card-text mb-1">
                                                <small><strong>–ì–æ–¥:</strong> <?php echo $book['year']; ?></small>
                                            </p>
                                        <?php endif; ?>

                                        <div class="mt-2">
                                            <a href="book_detail.php?id=<?php echo $book['id']; ?>" class="btn btn-sm btn-outline-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                            <a href="./api/download.php?id=<?php echo $book['id']; ?>" class="btn btn-sm btn-success">–°–∫–∞—á–∞—Ç—å</a>
                                            
                                            <?php if ($hasCover): ?>
                                                <small class="text-muted ms-2">‚úì –ï—Å—Ç—å –æ–±–ª–æ–∂–∫–∞</small>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <small class="text-muted">
                                    –î–æ–±–∞–≤–ª–µ–Ω–æ: <?php echo date('d.m.Y', strtotime($book['added_date'])); ?>
                                    <?php if ($book['file_type']): ?>
                                        ‚Ä¢ <?php echo strtoupper($book['file_type']); ?>
                                    <?php endif; ?>
                                    <?php if ($book['archive_path']): ?>
                                        ‚Ä¢ –í –∞—Ä—Ö–∏–≤–µ
                                    <?php endif; ?>
                                </small>
                            </div>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            <?php if ($totalPages > 1): ?>
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <?php if ($page > 1): ?>
                            <li class="page-item">
                                <a class="page-link" href="?q=<?php echo urlencode($searchQuery); ?>&field=<?php echo $searchField; ?>&page=<?php echo $page - 1; ?>">
                                    –ù–∞–∑–∞–¥
                                </a>
                            </li>
                        <?php endif; ?>

                        <?php
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
                        $startPage = max(1, $page - 2);
                        $endPage = min($totalPages, $page + 2);
                        
                        for ($i = $startPage; $i <= $endPage; $i++): ?>
                            <li class="page-item <?php echo $i == $page ? 'active' : ''; ?>">
                                <a class="page-link" href="?q=<?php echo urlencode($searchQuery); ?>&field=<?php echo $searchField; ?>&page=<?php echo $i; ?>">
                                    <?php echo $i; ?>
                                </a>
                            </li>
                        <?php endfor; ?>

                        <?php if ($page < $totalPages): ?>
                            <li class="page-item">
                                <a class="page-link" href="?q=<?php echo urlencode($searchQuery); ?>&field=<?php echo $searchField; ?>&page=<?php echo $page + 1; ?>">
                                    –í–ø–µ—Ä–µ–¥
                                </a>
                            </li>
                        <?php endif; ?>
                    </ul>
                </nav>
                
                <div class="text-center text-muted">
                    <small>–°—Ç—Ä–∞–Ω–∏—Ü–∞ <?php echo $page; ?> –∏–∑ <?php echo $totalPages; ?></small>
                </div>
            <?php endif; ?>
        <?php endif; ?>
    </div>
</div>

<?php
/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –æ–±–ª–æ–∂–∫–∞ –≤ –∫–Ω–∏–≥–µ
 */
function hasBookCover($book) {
    // –î–ª—è FB2 —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–ª–æ–∂–∫–∏
    if (strtolower($book['file_type']) === 'fb2') {
        $content = getBookContent($book);
        if ($content) {
            return Fb2CoverParser::findCover($content) !== false;
        }
    }
    return false;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏
 */
function getBookContent($book) {
    if ($book['archive_path'] && $book['archive_internal_path']) {
        $zip = new ZipArchive();
        if ($zip->open($book['archive_path']) === TRUE) {
            $content = $zip->getFromName($book['archive_internal_path']);
            $zip->close();
            return $content;
        }
    } else {
        return @file_get_contents($book['file_path']);
    }
    return false;
}
?>


<?php require 'templates/footer.php'; ?>
./api/cover_simple.php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../lib/Database.php';
require_once __DIR__ . '/../lib/Fb2CoverParser.php';

$id = $_GET['id'] ?? '';
$thumb = isset($_GET['thumb']);

if (!$id || !is_numeric($id)) {
    serveDefaultCover($thumb);
    exit;
}

$db = Database::getInstance();
$book = $db->getBook(intval($id));

if (!$book) {
    serveDefaultCover($thumb);
    exit;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
$coverPath = Config::COVER_CACHE_DIR . '/' . $id . ($thumb ? '_thumb.jpg' : '.jpg');
if (file_exists($coverPath)) {
    header('Content-Type: image/jpeg');
    header('Cache-Control: public, max-age=86400');
    readfile($coverPath);
    exit;
}

// –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±–ª–æ–∂–∫—É
$imageData = extractBookCover($book);
if ($imageData === false) {
    serveDefaultCover($thumb);
    exit;
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –∏ –æ—Ç–¥–∞–µ–º
if (saveCoverToCache($imageData, $id, $thumb)) {
    header('Content-Type: image/jpeg');
    header('Cache-Control: public, max-age=86400');
    
    if ($thumb) {
        // –î–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã —Å–æ–∑–¥–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        echo createThumbnailFromData($imageData, 200, 300);
    } else {
        echo $imageData;
    }
} else {
    serveDefaultCover($thumb);
}

function extractBookCover($book) {
    $content = getBookContent($book);
    if ($content === false) {
        return false;
    }
    
    // –î–ª—è FB2 —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
    if (strtolower($book['file_type']) === 'fb2') {
        return Fb2CoverParser::findCover($content);
    }
    
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä—ã
    return false;
}

function getBookContent($book) {
    if ($book['archive_path'] && $book['archive_internal_path']) {
        $zip = new ZipArchive();
        if ($zip->open($book['archive_path']) === TRUE) {
            $content = $zip->getFromName($book['archive_internal_path']);
            $zip->close();
            return $content;
        }
    } else {
        return file_get_contents($book['file_path']);
    }
    return false;
}

function saveCoverToCache($imageData, $id, $thumb) {
    if (!file_exists(Config::COVER_CACHE_DIR)) {
        mkdir(Config::COVER_CACHE_DIR, 0755, true);
    }
    
    $path = Config::COVER_CACHE_DIR . '/' . $id . ($thumb ? '_thumb.jpg' : '.jpg');
    
    if ($thumb) {
        $thumbData = createThumbnailFromData($imageData, 200, 300);
        return $thumbData ? file_put_contents($path, $thumbData) !== false : false;
    } else {
        return file_put_contents($path, $imageData) !== false;
    }
}

function createThumbnailFromData($imageData, $maxWidth, $maxHeight) {
    $tempFile = tempnam(sys_get_temp_dir(), 'cover_');
    file_put_contents($tempFile, $imageData);
    
    $imageInfo = getimagesize($tempFile);
    if (!$imageInfo) {
        unlink($tempFile);
        return false;
    }
    
    list($width, $height, $type) = $imageInfo;
    
    switch ($type) {
        case IMAGETYPE_JPEG: $source = imagecreatefromjpeg($tempFile); break;
        case IMAGETYPE_PNG: $source = imagecreatefrompng($tempFile); break;
        case IMAGETYPE_GIF: $source = imagecreatefromgif($tempFile); break;
        default: unlink($tempFile); return false;
    }
    
    if (!$source) {
        unlink($tempFile);
        return false;
    }
    
    $ratio = min($maxWidth / $width, $maxHeight / $height);
    $newWidth = (int)($width * $ratio);
    $newHeight = (int)($height * $ratio);
    
    $thumb = imagecreatetruecolor($newWidth, $newHeight);
    
    if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
        imagecolortransparent($thumb, imagecolorallocatealpha($thumb, 0, 0, 0, 127));
        imagealphablending($thumb, false);
        imagesavealpha($thumb, true);
    }
    
    imagecopyresampled($thumb, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    ob_start();
    imagejpeg($thumb, null, 85);
    $thumbData = ob_get_clean();
    
    imagedestroy($source);
    imagedestroy($thumb);
    unlink($tempFile);
    
    return $thumbData;
}

function serveDefaultCover($thumb) {
    $width = $thumb ? 200 : 600;
    $height = $thumb ? 300 : 800;
    
    $image = imagecreatetruecolor($width, $height);
    $bgColor = imagecolorallocate($image, 240, 240, 240);
    $textColor = imagecolorallocate($image, 150, 150, 150);
    $borderColor = imagecolorallocate($image, 200, 200, 200);
    
    imagefill($image, 0, 0, $bgColor);
    imagerectangle($image, 0, 0, $width-1, $height-1, $borderColor);
    
    $text = 'No Cover';
    $fontSize = $thumb ? 3 : 5;
    $textWidth = imagefontwidth($fontSize) * strlen($text);
    $textHeight = imagefontheight($fontSize);
    $x = ($width - $textWidth) / 2;
    $y = ($height - $textHeight) / 2;
    
    imagestring($image, $fontSize, $x, $y, $text, $textColor);
    
    header('Content-Type: image/jpeg');
    header('Cache-Control: public, max-age=3600');
    imagejpeg($image);
    imagedestroy($image);
    exit;
}
?>
./api/cover.php
<?php

require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../lib/Database.php';

class CoverExtractor {
    private $db;
    
    public function __construct() {
        $this->db = Database::getInstance();
    }
    
    public function serveCover($bookId, $isThumb = false) {
        $book = $this->db->getBook($bookId);
        if (!$book) {
            $this->serveDefaultCover($isThumb);
            return;
        }

        $coverPath = Config::COVER_CACHE_DIR . '/' . $bookId . ($isThumb ? '_thumb.jpg' : '.jpg');

        // –ï—Å–ª–∏ –æ–±–ª–æ–∂–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ –∫—ç—à–µ - –æ—Ç–¥–∞–µ–º –µ–µ
        if (file_exists($coverPath)) {
            $this->serveCachedCover($coverPath);
            return;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –æ–±–ª–æ–∂–∫—É
        if ($this->extractCover($book, $bookId, $isThumb)) {
            $this->serveCachedCover($coverPath);
        } else {
            $this->serveDefaultCover($isThumb);
        }
    }
    
    private function extractCover($book, $bookId, $isThumb) {
        $filePath = $book['file_path'];
        $internalPath = $book['archive_internal_path'];
        $fileType = strtolower($book['file_type']);
        
        // –î–ª—è FB2 —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        if ($fileType === 'fb2') {
            return $this->extractFb2CoverSimple($book, $bookId, $isThumb);
        }
        
        if ($internalPath) {
            return $this->extractCoverFromArchive($book, $bookId, $isThumb);
        } else {
            return $this->extractCoverFromFile($book, $bookId, $isThumb);
        }
    }
    
    /**
     * –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏ –∏–∑ FB2 (–∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
     */
    private function extractFb2CoverSimple($book, $bookId, $isThumb) {
        $content = $this->getBookContent($book);
        if ($content === false) {
            return false;
        }

        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –æ–±–ª–æ–∂–∫–∏ –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
        if (preg_match('/<coverpage>.*?<image[^>]*l:href="#([^"]+)".*?>/s', $content, $cover_match)) {
            $cover_id = $cover_match[1];
            
            // –ò—â–µ–º <binary> —Å —ç—Ç–∏–º ID
            if (preg_match('/<binary[^>]*id="' . preg_quote($cover_id, '/') . '"[^>]*content-type="([^"]+)"[^>]*>([^<]*)<\/binary>/s', $content, $binary_match)) {
                $mime_type = $binary_match[1];
                $image_data = base64_decode($binary_match[2]);

                if ($image_data !== false) {
                    return $this->saveImageData($image_data, $bookId, $isThumb, $mime_type);
                }
            }
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è binary
            if (preg_match('/<binary[^>]*id="' . preg_quote($cover_id, '/') . '"[^>]*>([^<]*)<\/binary>/s', $content, $binary_match)) {
                $image_data = base64_decode($binary_match[1]);
                if ($image_data !== false) {
                    return $this->saveImageData($image_data, $bookId, $isThumb);
                }
            }
        }
        
        return false;
    }
    
    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏ (–∏–∑ –∞—Ä—Ö–∏–≤–∞ –∏–ª–∏ —Ñ–∞–π–ª–∞)
     */
    private function getBookContent($book) {
        if ($book['archive_path'] && $book['archive_internal_path']) {
            // –§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞
            $zip = new ZipArchive();
            if ($zip->open($book['archive_path']) === TRUE) {
                $content = $zip->getFromName($book['archive_internal_path']);
                $zip->close();
                return $content;
            }
        } else {
            // –§–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ
            return file_get_contents($book['file_path']);
        }
        
        return false;
    }
    
    private function extractCoverFromFile($book, $bookId, $isThumb) {
        $filePath = $book['file_path'];
        $extension = strtolower($book['file_type']);
        
        switch ($extension) {
            case 'fb2':
                // –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ extractFb2CoverSimple
                return false;
            case 'epub':
                return $this->extractEpubCover($filePath, $bookId, $isThumb);
            case 'pdf':
                return $this->extractPdfCover($filePath, $bookId, $isThumb);
            case 'mobi':
                return $this->extractMobiCover($filePath, $bookId, $isThumb);
            default:
                return false;
        }
    }
    
    private function extractCoverFromArchive($book, $bookId, $isThumb) {
        $archivePath = $book['archive_path'];
        $internalPath = $book['archive_internal_path'];
        
        if (!file_exists($archivePath)) {
            return false;
        }
        
        // –î–ª—è FB2 –≤ –∞—Ä—Ö–∏–≤–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥
        if (strtolower(pathinfo($internalPath, PATHINFO_EXTENSION)) === 'fb2') {
            return $this->extractFb2CoverSimple($book, $bookId, $isThumb);
        }
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
        $tempDir = sys_get_temp_dir() . '/book_covers';
        if (!file_exists($tempDir)) {
            mkdir($tempDir, 0755, true);
        }
        
        $tempFile = $tempDir . '/' . $bookId . '_temp.' . pathinfo($internalPath, PATHINFO_EXTENSION);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª –∏–∑ –∞—Ä—Ö–∏–≤–∞
        if (!$this->extractFileFromArchive($archivePath, $internalPath, $tempFile)) {
            return false;
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±–ª–æ–∂–∫—É –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        $result = $this->extractCoverFromFile([
            'file_path' => $tempFile, 
            'file_type' => pathinfo($internalPath, PATHINFO_EXTENSION),
            'archive_path' => null,
            'archive_internal_path' => null
        ], $bookId, $isThumb);
        
        // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if (file_exists($tempFile)) {
            unlink($tempFile);
        }
        
        return $result;
    }
    
    private function extractFileFromArchive($archivePath, $internalPath, $outputFile) {
        $archiveType = strtolower(pathinfo($archivePath, PATHINFO_EXTENSION));
        
        switch ($archiveType) {
            case 'zip':
                return $this->extractFromZip($archivePath, $internalPath, $outputFile);
            case 'rar':
                return $this->extractFromRar($archivePath, $internalPath, $outputFile);
            case '7z':
                return $this->extractFrom7z($archivePath, $internalPath, $outputFile);
            default:
                return false;
        }
    }
    
    private function extractFromZip($archivePath, $internalPath, $outputFile) {
        $zip = new ZipArchive();
        if ($zip->open($archivePath) === TRUE) {
            $content = $zip->getFromName($internalPath);
            if ($content !== false) {
                file_put_contents($outputFile, $content);
                $zip->close();
                return true;
            }
            $zip->close();
        }
        return false;
    }
    
    private function extractFromRar($archivePath, $internalPath, $outputFile) {
        if (!class_exists('RarArchive')) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É
            $command = 'unrar p -inul ' . escapeshellarg($archivePath) . ' ' . 
                      escapeshellarg($internalPath) . ' > ' . escapeshellarg($outputFile) . ' 2>/dev/null';
            exec($command, $output, $returnCode);
            return $returnCode === 0 && file_exists($outputFile) && filesize($outputFile) > 0;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ Rar
        $rar = RarArchive::open($archivePath);
        if ($rar === false) return false;
        
        $entries = $rar->getEntries();
        foreach ($entries as $entry) {
            if ($entry->getName() === $internalPath) {
                $stream = $entry->getStream();
                if ($stream) {
                    file_put_contents($outputFile, stream_get_contents($stream));
                    fclose($stream);
                    $rar->close();
                    return true;
                }
            }
        }
        
        $rar->close();
        return false;
    }
    
    private function extractFrom7z($archivePath, $internalPath, $outputFile) {
        $command = '7z e -so ' . escapeshellarg($archivePath) . ' ' . 
                  escapeshellarg($internalPath) . ' 2>/dev/null > ' . escapeshellarg($outputFile);
        exec($command, $output, $returnCode);
        return $returnCode === 0 && file_exists($outputFile) && filesize($outputFile) > 0;
    }
    
    /**
     * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
     */
    private function saveImageData($imageData, $bookId, $isThumb, $mimeType = null) {
        $outputPath = Config::COVER_CACHE_DIR . '/' . $bookId . ($isThumb ? '_thumb.jpg' : '.jpg');
        
        // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (!file_exists(Config::COVER_CACHE_DIR)) {
            mkdir(Config::COVER_CACHE_DIR, 0755, true);
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –º–∏–Ω–∏–∞—Ç—é—Ä–∞, —Å–æ–∑–¥–∞–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        if ($isThumb) {
            return $this->createThumbnailFromData($imageData, $outputPath, 200, 300);
        } else {
            // –î–ª—è –ø–æ–ª–Ω–æ—Ä–∞–∑–º–µ—Ä–Ω–æ–π –æ–±–ª–æ–∂–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            return file_put_contents($outputPath, $imageData) !== false;
        }
    }
    
    private function createThumbnailFromData($imageData, $destPath, $maxWidth, $maxHeight) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        $tempFile = tempnam(sys_get_temp_dir(), 'cover_');
        file_put_contents($tempFile, $imageData);
        
        $result = $this->createThumbnail($tempFile, $destPath, $maxWidth, $maxHeight);
        
        unlink($tempFile);
        return $result;
    }
    
    private function createThumbnail($sourcePath, $destPath, $maxWidth, $maxHeight) {
        if (!extension_loaded('gd')) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º ImageMagick –µ—Å–ª–∏ GD –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
            $command = 'convert ' . escapeshellarg($sourcePath) . 
                      ' -resize ' . $maxWidth . 'x' . $maxHeight . 
                      ' -quality 85 ' . escapeshellarg($destPath) . ' 2>/dev/null';
            exec($command, $output, $returnCode);
            return $returnCode === 0;
        }
        
        $imageInfo = getimagesize($sourcePath);
        if (!$imageInfo) return false;
        
        list($width, $height, $type) = $imageInfo;
        
        switch ($type) {
            case IMAGETYPE_JPEG:
                $source = imagecreatefromjpeg($sourcePath);
                break;
            case IMAGETYPE_PNG:
                $source = imagecreatefrompng($sourcePath);
                break;
            case IMAGETYPE_GIF:
                $source = imagecreatefromgif($sourcePath);
                break;
            default:
                return false;
        }
        
        if (!$source) return false;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
        $ratio = min($maxWidth / $width, $maxHeight / $height);
        $newWidth = (int)($width * $ratio);
        $newHeight = (int)($height * $ratio);
        
        $thumb = imagecreatetruecolor($newWidth, $newHeight);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è PNG –∏ GIF
        if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
            imagecolortransparent($thumb, imagecolorallocatealpha($thumb, 0, 0, 0, 127));
            imagealphablending($thumb, false);
            imagesavealpha($thumb, true);
        }
        
        imagecopyresampled($thumb, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);
        
        $result = imagejpeg($thumb, $destPath, 85);
        imagedestroy($source);
        imagedestroy($thumb);
        
        return $result;
    }
    
    // –ú–µ—Ç–æ–¥—ã –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (EPUB, PDF, MOBI) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    private function extractEpubCover($filePath, $bookId, $isThumb) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è EPUB ...
        return false;
    }
    
    private function extractPdfCover($filePath, $bookId, $isThumb) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è PDF ...
        return false;
    }
    
    private function extractMobiCover($filePath, $bookId, $isThumb) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è MOBI ...
        return false;
    }
    
    private function serveCachedCover($coverPath) {
        header('Content-Type: image/jpeg');
        header('Cache-Control: public, max-age=86400');
        header('Expires: ' . gmdate('D, d M Y H:i:s', time() + 86400) . ' GMT');
        readfile($coverPath);
    }
    
    private function serveDefaultCover($isThumb) {
        $width = $isThumb ? 200 : 600;
        $height = $isThumb ? 300 : 800;
        
        $image = imagecreatetruecolor($width, $height);
        $bgColor = imagecolorallocate($image, 240, 240, 240);
        $textColor = imagecolorallocate($image, 150, 150, 150);
        $borderColor = imagecolorallocate($image, 200, 200, 200);
        
        imagefill($image, 0, 0, $bgColor);
        imagerectangle($image, 0, 0, $width-1, $height-1, $borderColor);
        
        $text = 'No Cover';
        $fontSize = $isThumb ? 3 : 5;
        $textWidth = imagefontwidth($fontSize) * strlen($text);
        $textHeight = imagefontheight($fontSize);
        $x = ($width - $textWidth) / 2;
        $y = ($height - $textHeight) / 2;
        
        imagestring($image, $fontSize, $x, $y, $text, $textColor);
        
        header('Content-Type: image/jpeg');
        header('Cache-Control: public, max-age=3600');
        imagejpeg($image);
        imagedestroy($image);
    }
}

// –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    http_response_code(400);
    header('Content-Type: text/plain');
    exit('Invalid book ID');
}

$bookId = intval($_GET['id']);
$isThumb = isset($_GET['thumb']);

try {
    $extractor = new CoverExtractor();
    $extractor->serveCover($bookId, $isThumb);
} catch (Exception $e) {
    error_log("Cover extraction error: " . $e->getMessage());
    http_response_code(500);
    header('Content-Type: text/plain');
    exit('Error extracting cover');
}
?>
./api/opds.php
<?php

require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../lib/Database.php';
require_once __DIR__ . '/../lib/OpdsGenerator.php';

// –ë–∞–∑–æ–≤—ã–π URL
$baseUrl = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . 
           "://" . $_SERVER['HTTP_HOST'] . dirname(dirname($_SERVER['SCRIPT_NAME']));

$generator = new OpdsGenerator($baseUrl);

try {
    $page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;
    
    if (isset($_GET['search']) && !empty($_GET['search'])) {
        echo $generator->generateSearchResults($_GET['search'], $page);
    } elseif (isset($_GET['by']) && $_GET['by'] === 'authors') {
        echo $generator->generateByAuthors($page);
    } elseif (isset($_GET['by']) && $_GET['by'] === 'genres') {
        echo $generator->generateByGenres($page);
    } elseif (isset($_GET['author']) && !empty($_GET['author'])) {
        echo $generator->generateByAuthor($_GET['author'], $page);
    } elseif (isset($_GET['genre']) && !empty($_GET['genre'])) {
        echo $generator->generateByGenre($_GET['genre'], $page);
    } else {
        echo $generator->generateCatalog($page);
    }
} catch (Exception $e) {
    header('Content-Type: text/xml; charset=utf-8');
    echo '<?xml version="1.0" encoding="UTF-8"?>';
    echo '<error><message>' . htmlspecialchars($e->getMessage()) . '</message></error>';
}
?>
./api/download.php
<?php

require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../lib/Database.php';

$db = Database::getInstance();

if (!isset($_GET['id']) || !is_numeric($_GET['id'])) {
    http_response_code(400);
    die('Invalid book ID');
}

$bookId = intval($_GET['id']);
$book = $db->getBook($bookId);

if (!$book) {
    http_response_code(404);
    die('Book not found');
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
if ($book['archive_path'] && $book['archive_internal_path']) {
    // –ö–Ω–∏–≥–∞ –≤ –∞—Ä—Ö–∏–≤–µ - –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å
    downloadFromArchive($book);
} else {
    // –û–±—ã—á–Ω—ã–π —Ñ–∞–π–ª
    downloadRegularFile($book);
}

function downloadRegularFile($book) {
    $filePath = $book['file_path'];
    
    if (!file_exists($filePath)) {
        http_response_code(404);
        die('File not found');
    }
    
    $filename = basename($filePath);
    $mimeType = getMimeType($book['file_type']);
    
    header('Content-Type: ' . $mimeType);
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    header('Content-Length: ' . filesize($filePath));
    
    readfile($filePath);
    exit;
}

function downloadFromArchive($book) {
    $archivePath = $book['archive_path'];
    $internalPath = $book['archive_internal_path'];
    
    if (!file_exists($archivePath)) {
        http_response_code(404);
        die('Archive not found');
    }
    
    $extension = pathinfo($internalPath, PATHINFO_EXTENSION);
    $filename = ($book['title'] ?: 'book') . '.' . $extension;
    $mimeType = getMimeType($extension);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ –∞—Ä—Ö–∏–≤–∞
    $archiveType = pathinfo($archivePath, PATHINFO_EXTENSION);
    
    switch (strtolower($archiveType)) {
        case 'zip':
            $command = 'unzip -p ' . escapeshellarg($archivePath) . ' ' . escapeshellarg($internalPath);
            break;
        case 'rar':
            $command = 'unrar p -inul ' . escapeshellarg($archivePath) . ' ' . escapeshellarg($internalPath);
            break;
        case '7z':
            $command = '7z e -so ' . escapeshellarg($archivePath) . ' ' . escapeshellarg($internalPath) . ' 2>/dev/null';
            break;
        default:
            http_response_code(500);
            die('Unsupported archive format');
    }
    
    header('Content-Type: ' . $mimeType);
    header('Content-Disposition: attachment; filename="' . $filename . '"');
    
    passthru($command);
    exit;
}

function getMimeType($fileType) {
    $mimeTypes = [
        'epub' => 'application/epub+zip',
        'pdf' => 'application/pdf',
        'fb2' => 'application/x-fictionbook+xml',
        'mobi' => 'application/x-mobipocket-ebook',
        'txt' => 'text/plain'
    ];
    
    return $mimeTypes[strtolower($fileType)] ?? 'application/octet-stream';
}
?>
./api/cover_direct.php
<?php
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../lib/Database.php';
require_once __DIR__ . '/../lib/Fb2CoverParser.php';

$id = $_GET['id'] ?? '';
$thumb = isset($_GET['thumb']);

if (!$id || !is_numeric($id)) {
    serveDefaultCover($thumb);
    exit;
}

$db = Database::getInstance();
$book = $db->getBook(intval($id));

if (!$book) {
    serveDefaultCover($thumb);
    exit;
}

// –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–±–ª–æ–∂–∫—É –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–Ω–∏–≥–∏
$imageData = extractBookCover($book);
if ($imageData === false) {
    serveDefaultCover($thumb);
    exit;
}

// –û—Ç–¥–∞–µ–º –æ–±–ª–æ–∂–∫—É –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
header('Content-Type: image/jpeg');
header('Cache-Control: no-cache, must-revalidate');

if ($thumb) {
    // –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –Ω–∞ –ª–µ—Ç—É
    echo createThumbnailFromData($imageData, 200, 300);
} else {
    echo $imageData;
}

/**
 * –ò–∑–≤–ª–µ—á—å –æ–±–ª–æ–∂–∫—É –∏–∑ –∫–Ω–∏–≥–∏
 */
function extractBookCover($book) {
    $content = getBookContent($book);
    if ($content === false) {
        return false;
    }
    
    // –î–ª—è FB2 —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
    if (strtolower($book['file_type']) === 'fb2') {
        return Fb2CoverParser::findCover($content);
    }
    
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä—ã
    return false;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–∏–≥–∏
 */
function getBookContent($book) {
    if ($book['archive_path'] && $book['archive_internal_path']) {
        $zip = new ZipArchive();
        if ($zip->open($book['archive_path']) === TRUE) {
            $content = $zip->getFromName($book['archive_internal_path']);
            $zip->close();
            return $content;
        }
    } else {
        return @file_get_contents($book['file_path']);
    }
    return false;
}

/**
 * –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö
 */
function createThumbnailFromData($imageData, $maxWidth, $maxHeight) {
    $tempFile = tempnam(sys_get_temp_dir(), 'cover_');
    file_put_contents($tempFile, $imageData);
    
    $imageInfo = getimagesize($tempFile);
    if (!$imageInfo) {
        unlink($tempFile);
        return false;
    }
    
    list($width, $height, $type) = $imageInfo;
    
    switch ($type) {
        case IMAGETYPE_JPEG: $source = imagecreatefromjpeg($tempFile); break;
        case IMAGETYPE_PNG: $source = imagecreatefrompng($tempFile); break;
        case IMAGETYPE_GIF: $source = imagecreatefromgif($tempFile); break;
        default: unlink($tempFile); return false;
    }
    
    if (!$source) {
        unlink($tempFile);
        return false;
    }
    
    $ratio = min($maxWidth / $width, $maxHeight / $height);
    $newWidth = (int)($width * $ratio);
    $newHeight = (int)($height * $ratio);
    
    $thumb = imagecreatetruecolor($newWidth, $newHeight);
    
    if ($type == IMAGETYPE_PNG || $type == IMAGETYPE_GIF) {
        imagecolortransparent($thumb, imagecolorallocatealpha($thumb, 0, 0, 0, 127));
        imagealphablending($thumb, false);
        imagesavealpha($thumb, true);
    }
    
    imagecopyresampled($thumb, $source, 0, 0, 0, 0, $newWidth, $newHeight, $width, $height);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    ob_start();
    imagejpeg($thumb, null, 85);
    $thumbData = ob_get_clean();
    
    imagedestroy($source);
    imagedestroy($thumb);
    unlink($tempFile);
    
    return $thumbData;
}

function serveDefaultCover($thumb) {
    $width = $thumb ? 200 : 600;
    $height = $thumb ? 300 : 800;
    
    $image = imagecreatetruecolor($width, $height);
    $bgColor = imagecolorallocate($image, 240, 240, 240);
    $textColor = imagecolorallocate($image, 150, 150, 150);
    $borderColor = imagecolorallocate($image, 200, 200, 200);
    
    imagefill($image, 0, 0, $bgColor);
    imagerectangle($image, 0, 0, $width-1, $height-1, $borderColor);
    
    $text = 'No Cover';
    $fontSize = $thumb ? 3 : 5;
    $textWidth = imagefontwidth($fontSize) * strlen($text);
    $textHeight = imagefontheight($fontSize);
    $x = ($width - $textWidth) / 2;
    $y = ($height - $textHeight) / 2;
    
    imagestring($image, $fontSize, $x, $y, $text, $textColor);
    
    header('Content-Type: image/jpeg');
    header('Cache-Control: no-cache');
    imagejpeg($image);
    imagedestroy($image);
    exit;
}
?>
